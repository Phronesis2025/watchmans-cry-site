<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XCVPZDXKE6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XCVPZDXKE6');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchman Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <!-- Chart.js for bar charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>The Watchman's Cry – Admin Only</h1>
        <img src="images/divider.png" alt="divider" class="divider" />
      </header>

      <div id="login" style="text-align: center; margin: 4em 0">
        <h3>Admin Access</h3>
        <div id="login-form" style="max-width: 400px; margin: 0 auto">
          <input
            type="email"
            id="admin-email"
            placeholder="Email"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <input
            type="password"
            id="admin-password"
            placeholder="Password"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <button
            onclick="signIn()"
            style="
              padding: 0.75em 2em;
              background-color: #000;
              color: #f4e8d4;
              border: none;
              font-family: 'EB Garamond', serif;
              font-size: 1em;
              font-weight: 700;
              cursor: pointer;
              width: 100%;
            "
          >
            Sign In
          </button>
          <p
            id="login-error"
            style="color: darkred; margin-top: 1em; display: none"
          ></p>
        </div>
        <!-- Signup disabled for security - accounts must be created through Supabase dashboard -->
        <p
          id="signup-info"
          style="font-size: 0.9em; color: #666; margin-top: 1em; display: none"
        >
          Admin accounts must be created through the Supabase dashboard for
          security.
        </p>
      </div>

      <div id="admin-content" style="display: none">
        <h2>Submissions</h2>

        <h3>Counsel Questions</h3>
        <div id="counsel-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Site Metrics</h3>
        <div id="site-metrics" style="margin-bottom: 2em">
          <p>Loading site metrics...</p>
        </div>
      </div>

      <script>
        // Security: HTML escaping function to prevent XSS attacks
        function escapeHtml(text) {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        // Helper: Format seconds to "Xm Ys" format
        function formatTime(seconds) {
          if (!seconds || seconds === 0) return '0s';
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          if (minutes > 0) {
            return `${minutes}m ${secs}s`;
          }
          return `${secs}s`;
        }

        // Convert page path to common name
        // Normalize page path - combine / and /index.html
        function normalizePagePath(path) {
          if (!path) return '/';
          // Normalize /index.html to /
          if (path === '/index.html' || path === 'index.html') {
            return '/';
          }
          return path;
        }

        function getPageName(path) {
          // Normalize path first
          const normalizedPath = normalizePagePath(path);
          
          // Check if it's a section path (homepage sections)
          if (normalizedPath.startsWith('/section/')) {
            const sectionPath = normalizedPath.replace('/section/', '');
            const sectionNames = {
              'opening-dispatch': 'Opening Dispatch',
              'plain-truth': 'The Plain Truth',
              'prophetic-parallels': 'Prophetic Parallels',
              'victory-reports': 'Victory Reports',
              'common-mans-counsel': 'The Common Man\'s Counsel',
              'practical-self-reliance': 'Practical Self-Reliance Corner',
              'prayer-closing': 'Prayer of the Week & Closing Call'
            };
            return sectionNames[sectionPath] || `Section: ${sectionPath}`;
          }
          
          const pageNames = {
            '/': 'Home',
            '/about.html': 'About',
            '/submit.html': 'Submit',
            '/staff.html': 'Voices',
            '/archive.html': 'Archive',
            '/privacy-policy.html': 'Privacy Policy',
            '/test-analytics.html': 'Test Analytics',
            '/admin.html': 'Admin',
            '/prelaunch.html': 'Prelaunch'
          };
          
          // Check exact match first
          if (pageNames[normalizedPath]) {
            return pageNames[normalizedPath];
          }
          
          // Check if it's an archive edition
          if (normalizedPath.startsWith('/archive/')) {
            const match = normalizedPath.match(/edition-(\d{4}-\d{2}-\d{2})/);
            if (match) {
              return `Edition ${match[1]}`;
            }
            return 'Archive Edition';
          }
          
          // Fallback: return path without leading slash
          return normalizedPath.replace(/^\//, '') || 'Home';
        }

        // Check if user is already signed in on page load
        window.addEventListener("DOMContentLoaded", async () => {
          const {
            data: { session },
          } = await supabaseClient.auth.getSession();
          if (session) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            loadSubmissions();
          }
        });

        // Signup function removed for security - accounts must be created via Supabase dashboard

        async function signIn() {
          const email = document.getElementById("admin-email").value;
          const password = document.getElementById("admin-password").value;
          const errorEl = document.getElementById("login-error");

          if (!email || !password) {
            errorEl.textContent = "Please enter both email and password.";
            errorEl.style.display = "block";
            return;
          }

          errorEl.style.display = "none";

          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            // Security: Don't expose detailed error messages that could help attackers
            errorEl.textContent =
              "Invalid email or password. Please try again.";
            errorEl.style.display = "block";
            return;
          }

          // Success - hide login, show admin content
          document.getElementById("login").style.display = "none";
          document.getElementById("admin-content").style.display = "block";
          loadSubmissions();
        }

        // Signup function removed for security - prevent unauthorized account creation

        async function loadSubmissions() {
          // Load counsel questions data
          const counselEl = document.getElementById("counsel-data");
          counselEl.innerHTML = "<p>Loading counsel questions...</p>";

          try {
            console.log(
              "Attempting to load counsel questions from Supabase..."
            );
            const { data: counsel, error: counselError } = await supabaseClient
              .from("counsel_questions")
              .select("*")
              .order("created_at", { ascending: false });

            console.log("Supabase response:", {
              data: counsel,
              error: counselError,
            });

            if (counselError) {
              console.error("Supabase error:", counselError);
              counselEl.innerHTML = `
                <p style="color: darkred;"><strong>Error:</strong> ${escapeHtml(
                  counselError.message
                )}</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                  <strong>Note:</strong> This is likely a Row Level Security (RLS) policy issue. 
                  To fix this, you need to:
                  <ol style="margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Go to your Supabase dashboard</li>
                    <li>Navigate to Authentication → Policies for the "counsel_questions" table</li>
                    <li>Create a policy that allows SELECT operations (or temporarily disable RLS for testing)</li>
                    <li>Alternatively, use a service_role key server-side (never expose this in client code)</li>
                  </ol>
                  <p style="margin-top: 0.5em;">
                    <strong>Debug info:</strong> Check browser console (F12) for detailed error information.
                  </p>
                </p>
              `;
            } else if (!counsel || counsel.length === 0) {
              counselEl.innerHTML = "<p>No counsel questions yet.</p>";
            } else {
              console.log(`Loaded ${counsel.length} counsel questions`);
              let html = `<p><strong>Total: ${counsel.length} questions</strong></p>`;
              html += `<table style="width: 100%; border-collapse: collapse; margin-top: 1em; border: 1px solid #000;">`;
              html += `<thead>`;
              html += `<tr style="background-color: rgba(244, 232, 212, 0.5); border-bottom: 2px solid #000;">`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Date</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Name</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Profession</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">State</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Question</th>`;
              html += `</tr>`;
              html += `</thead>`;
              html += `<tbody>`;
              counsel.forEach((entry) => {
                const date = entry.created_at
                  ? new Date(entry.created_at).toLocaleDateString()
                  : "Date unknown";
                html += `<tr style="border-bottom: 1px solid #000;">`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  date
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.name || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.profession || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.state || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.question || "No question text"
                )}</td>`;
                html += `</tr>`;
              });
              html += `</tbody>`;
              html += `</table>`;
              counselEl.innerHTML = html;
            }
          } catch (err) {
            console.error("Exception loading counsel questions:", err);
            counselEl.innerHTML = `
              <p style="color: darkred;"><strong>Error loading counsel questions:</strong> ${escapeHtml(
                err.message
              )}</p>
              <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                Check browser console (F12) for more details.
              </p>
            `;
          }

          // Load Site Metrics (Supabase Analytics)
          loadSiteMetrics();
        }

        async function loadSiteMetrics() {
          const metricsEl = document.getElementById("site-metrics");
          metricsEl.innerHTML = "<p>Loading site metrics...</p>";

          try {
            // Get current session token
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              metricsEl.innerHTML = `
                <p><strong>Site Analytics</strong></p>
                <p style="color: darkred;">Please sign in to view analytics.</p>
              `;
              return;
            }

            // Get selected period from dropdown or default to 7d
            const periodSelect = document.getElementById('analytics-period');
            const period = periodSelect ? periodSelect.value : '7d';
            const token = session.access_token;

            const [pageviewsRes, visitorsRes, devicesRes, timeonpageRes, timelineRes, growthRes, engagementRes, sourcesRes, contentRes, journeyRes] = await Promise.all([
              fetch(`/api/analytics-data?metric=pageviews&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=visitors&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=devices&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=timeonpage&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=timeline&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=growth&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=engagement&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=sources&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=content&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=journey&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null)
            ]);

            let html = `
              <p><strong>Site Analytics</strong></p>
              <div style="margin-bottom: 1em; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5em;">
                <div>
                  <label style="font-weight: 700; margin-right: 0.5em;">Time Period:</label>
                  <select id="analytics-period" onchange="loadSiteMetrics()" style="padding: 0.25em; border: 1px solid #000; font-family: 'EB Garamond', serif;">
                    <option value="7d" ${period === '7d' ? 'selected' : ''}>Last 7 days</option>
                    <option value="30d" ${period === '30d' ? 'selected' : ''}>Last 30 days</option>
                    <option value="all" ${period === 'all' ? 'selected' : ''}>All time</option>
                  </select>
                  <button onclick="loadSiteMetrics()" style="margin-left: 0.5em; padding: 0.25em 0.75em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer;">Refresh</button>
                </div>
                <button onclick="resetAnalyticsData()" style="padding: 0.25em 0.75em; background-color: #8b0000; color: #f4e8d4; border: 1px solid #8b0000; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.9em;" title="Delete all analytics data and start fresh">Reset All Data</button>
              </div>
              
              <!-- Enhanced KPI Cards with Trends (styled like modern stat cards, in site colors) -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25em; margin-bottom: 2em;">
                <!-- Page Views Card with Growth -->
                <div style="padding: 1.25em 1.1em; background: linear-gradient(135deg, rgba(244, 232, 212, 0.95), rgba(219, 189, 140, 0.95)); border: 1px solid #000; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.18); text-align: left; position: relative; overflow: hidden;">
                  <p style="font-size: 0.9em; color: #4a3a2a; margin-bottom: 0.35em; text-transform: uppercase; letter-spacing: 0.04em;">Total Page Views</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0; color: #000;">${pageviewsRes?.total || 0}</p>
                  ${growthRes?.pageviews ? `
                    <p style="font-size: 0.85em; margin-top: 0.5em; color: ${growthRes.pageviews.change > 0 ? '#006400' : growthRes.pageviews.change < 0 ? '#8b0000' : '#666'};">
                      ${growthRes.pageviews.change > 0 ? '↗️' : growthRes.pageviews.change < 0 ? '↘️' : '→'} 
                      ${Math.abs(growthRes.pageviews.change)}% vs previous period
                    </p>
                    <p style="font-size: 0.8em; color: #666; margin-top: 0.15em;">Trend: ${growthRes.pageviews.trend === 'up' ? 'Growing' : growthRes.pageviews.trend === 'down' ? 'Declining' : 'Stable'}</p>
                  ` : ''}
                  <p style="font-size: 0.85em; color: #4a3a2a; margin-top: 0.75em; font-style: italic; line-height: 1.4;">
                    Total number of pages viewed. Shows overall site traffic and content consumption.
                  </p>
                </div>
                
                <!-- Unique Visitors Card with Return Rate -->
                <div style="padding: 1.25em 1.1em; background: linear-gradient(135deg, rgba(244, 232, 212, 0.95), rgba(219, 189, 140, 0.95)); border: 1px solid #000; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.18); text-align: left; position: relative; overflow: hidden;">
                  <p style="font-size: 0.9em; color: #4a3a2a; margin-bottom: 0.35em; text-transform: uppercase; letter-spacing: 0.04em;">Unique Visitors</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0; color: #000;">${visitorsRes?.unique_visitors || 0}</p>
                  ${growthRes?.visitors ? `
                    <p style="font-size: 0.85em; margin-top: 0.5em; color: ${growthRes.visitors.change > 0 ? '#006400' : growthRes.visitors.change < 0 ? '#8b0000' : '#666'};">
                      ${growthRes.visitors.change > 0 ? '↗️' : growthRes.visitors.change < 0 ? '↘️' : '→'} 
                      ${Math.abs(growthRes.visitors.change)}% vs previous
                    </p>
                  ` : ''}
                  ${engagementRes?.return_rate !== undefined ? `
                    <p style="font-size: 0.8em; color: #666; margin-top: 0.15em;">${engagementRes.return_rate}% returning</p>
                  ` : ''}
                  <p style="font-size: 0.85em; color: #4a3a2a; margin-top: 0.75em; font-style: italic; line-height: 1.4;">
                    Distinct individuals visiting your site. Higher numbers indicate growing audience reach.
                  </p>
                </div>
                
                <!-- Engagement Card (New) -->
                <div style="padding: 1.25em 1.1em; background: linear-gradient(135deg, rgba(244, 232, 212, 0.95), rgba(219, 189, 140, 0.95)); border: 1px solid #000; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.18); text-align: left; position: relative; overflow: hidden;">
                  <p style="font-size: 0.9em; color: #4a3a2a; margin-bottom: 0.35em; text-transform: uppercase; letter-spacing: 0.04em;">Engagement Quality</p>
                  ${engagementRes ? `
                    <p style="font-size: 1.5em; font-weight: 700; margin: 0; color: ${engagementRes.bounce_rate < 50 ? '#006400' : engagementRes.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">
                      ${engagementRes.bounce_rate}% bounce
                    </p>
                    <p style="font-size: 0.8em; color: #666; margin-top: 0.15em;">
                      ${engagementRes.pages_per_session?.average || 0} pages/session
                    </p>
                  ` : '<p style="font-size: 1.5em; font-weight: 700; margin: 0;">-</p>'}
                  <p style="font-size: 0.85em; color: #4a3a2a; margin-top: 0.75em; font-style: italic; line-height: 1.4;">
                    Bounce rate shows single-page visits. Lower is better—indicates visitors explore multiple pages.
                  </p>
                </div>
                
                <!-- Time on Page Card Enhanced -->
                <div style="padding: 1.25em 1.1em; background: linear-gradient(135deg, rgba(244, 232, 212, 0.95), rgba(219, 189, 140, 0.95)); border: 1px solid #000; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.18); text-align: left; position: relative; overflow: hidden;">
                  <p style="font-size: 0.9em; color: #4a3a2a; margin-bottom: 0.35em; text-transform: uppercase; letter-spacing: 0.04em;">Avg. Time on Page</p>
                  ${timeonpageRes?.overall_average ? `
                    <p style="font-size: 2em; font-weight: 700; margin: 0; color: #000;">
                      ${Math.floor(timeonpageRes.overall_average / 60)}m ${timeonpageRes.overall_average % 60}s
                    </p>
                  ` : '<p style="font-size: 2em; font-weight: 700; margin: 0; color: #000;">0s</p>'}
                  ${growthRes?.time_on_page ? `
                    <p style="font-size: 0.85em; margin-top: 0.5em; color: ${growthRes.time_on_page.change > 0 ? '#006400' : growthRes.time_on_page.change < 0 ? '#8b0000' : '#666'};">
                      ${growthRes.time_on_page.change > 0 ? '↗️' : growthRes.time_on_page.change < 0 ? '↘️' : '→'} 
                      ${Math.abs(growthRes.time_on_page.change)}%
                    </p>
                  ` : ''}
                  ${engagementRes?.time_distribution ? `
                    <p style="font-size: 0.75em; color: #666; margin-top: 0.25em;">
                      ${Math.round(((engagementRes.time_distribution['2-5min'] + engagementRes.time_distribution['5min+']) / 
                        (engagementRes.time_distribution['0-30s'] + engagementRes.time_distribution['30s-1min'] + 
                         engagementRes.time_distribution['1-2min'] + engagementRes.time_distribution['2-5min'] + 
                         engagementRes.time_distribution['5min+']) * 100) || 0)}% read 2+ min
                    </p>
                  ` : ''}
                  <p style="font-size: 0.85em; color: #4a3a2a; margin-top: 0.75em; font-style: italic; line-height: 1.4;">
                    Average time visitors spend reading (only counts when tab is visible). Higher indicates deeper engagement.
                  </p>
                </div>
              </div>

              <!-- Traffic Trend Chart (Daily with Comparison) -->
              ${pageviewsRes?.daily?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Traffic Trend (Daily Page Views)</h4>
                <canvas id="trafficTrendChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              <!-- Visitor Activity Timeline Chart (Click to Drill Down) -->
              ${timelineRes?.months?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
                  <h4 style="margin: 0;">Visitor Activity Timeline</h4>
                  <div id="timeline-breadcrumb" style="font-size: 0.9em; color: #666;">
                    <span id="timeline-level-indicator">Viewing: Months (click a bar to drill down)</span>
                    <button id="timeline-back-btn" onclick="goBackTimeline()" style="margin-left: 0.5em; padding: 0.25em 0.5em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.85em; display: none;">← Back</button>
                  </div>
                </div>
                <canvas id="timelineChart" style="max-height: 500px;"></canvas>
                ${timelineRes?.peak_day || timelineRes?.peak_hour ? `
                <div style="margin-top: 1em; font-size: 0.9em; color: #666;">
                  ${timelineRes.peak_day ? `<p style="margin: 0.25em 0;"><strong>Peak Day:</strong> ${timelineRes.peak_day.day} (${timelineRes.peak_day.count} visits)</p>` : ''}
                  ${timelineRes.peak_hour ? `<p style="margin: 0.25em 0;"><strong>Peak Hour:</strong> ${timelineRes.peak_hour.label} (${timelineRes.peak_hour.count} visits)</p>` : ''}
                </div>
                ` : ''}
              </div>
              ` : ''}

              <!-- Day of Week Analysis -->
              ${timelineRes?.day_of_week?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Traffic by Day of Week</h4>
                <canvas id="dayOfWeekChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              <!-- Engagement Distribution Charts -->
              ${engagementRes ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Engagement Quality Metrics</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1em;">
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Time on Page Distribution</h5>
                    <canvas id="timeDistributionChart" style="max-height: 250px;"></canvas>
                  </div>
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Pages per Session</h5>
                    <canvas id="pagesPerSessionChart" style="max-height: 250px;"></canvas>
                  </div>
                </div>
                <div style="margin-top: 1em; padding: 1em; background-color: rgba(255, 255, 255, 0.2); border: 1px solid #000;">
                  <p style="margin: 0.25em 0;"><strong>Bounce Rate:</strong> ${engagementRes.bounce_rate}% ${engagementRes.bounce_rate < 50 ? '(Good)' : engagementRes.bounce_rate < 70 ? '(Fair)' : '(Needs Improvement)'}</p>
                  <p style="margin: 0.25em 0;"><strong>Return Visitor Rate:</strong> ${engagementRes.return_rate}%</p>
                  <p style="margin: 0.25em 0;"><strong>Avg Session Duration:</strong> ${Math.floor((engagementRes.session_duration?.average || 0) / 60)}m ${(engagementRes.session_duration?.average || 0) % 60}s</p>
                </div>
              </div>
              ` : ''}

              <!-- Traffic Sources -->
              ${sourcesRes?.categories?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Traffic Sources</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1em;">
                  <div>
                    <canvas id="sourcesPieChart" style="max-height: 300px;"></canvas>
                  </div>
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Top Referrers</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                      <thead>
                        <tr style="border-bottom: 2px solid #000;">
                          <th style="padding: 0.5em; text-align: left; font-weight: 700;">Source</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">Visits</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">Bounce</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${sourcesRes.top_referrers?.slice(0, 5).map(ref => `
                          <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 0.5em;">${escapeHtml(ref.domain)}</td>
                            <td style="padding: 0.5em; text-align: right;">${ref.count}</td>
                            <td style="padding: 0.5em; text-align: right; color: ${ref.bounce_rate < 50 ? '#006400' : ref.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">${ref.bounce_rate}%</td>
                          </tr>
                        `).join('') || '<tr><td colspan="3" style="padding: 0.5em; text-align: center; color: #666;">No referrer data</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              ` : ''}

              <!-- Screen Time Heatmap (Most Time Spent) -->
              ${contentRes?.screen_time?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Screen Time Heatmap (Where Users Spend Most Time)</h4>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">Visual representation of which pages/sections get the most screen time. Darker colors indicate more total time spent reading.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1em;">
                  ${contentRes.screen_time.slice(0, 20).map(page => {
                    const maxTime = Math.max(...contentRes.screen_time.map(p => p.total_screen_time));
                    const intensity = maxTime > 0 ? Math.round((page.total_screen_time / maxTime) * 100) : 0;
                    const bgColor = `rgba(0, 0, 0, ${0.3 + (intensity / 100) * 0.7})`;
                    const hours = Math.floor(page.total_screen_time / 3600);
                    const minutes = Math.floor((page.total_screen_time % 3600) / 60);
                    const timeDisplay = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    return `
                      <div style="padding: 1em; background-color: ${bgColor}; color: #f4e8d4; border: 1px solid #000; text-align: center;">
                        <p style="font-weight: 700; margin-bottom: 0.5em; font-size: 0.9em;">${escapeHtml(getPageName(page.path))}</p>
                        <p style="font-size: 1.5em; font-weight: 700; margin: 0;">${timeDisplay}</p>
                        <p style="font-size: 0.75em; margin-top: 0.25em; opacity: 0.9;">total screen time</p>
                        <p style="font-size: 0.7em; margin-top: 0.25em; opacity: 0.8;">${Math.floor(page.avg_screen_time / 60)}m avg per visit</p>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              ` : ''}

              <!-- Page Views Heatmap -->
              ${contentRes?.top_pages?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Page Views Heatmap (Most Viewed Content)</h4>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">Visual representation of which pages users view most. Darker colors indicate higher view counts.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1em;">
                  ${contentRes.top_pages.slice(0, 15).map(page => {
                    const maxViews = Math.max(...contentRes.top_pages.map(p => p.views));
                    const intensity = maxViews > 0 ? Math.round((page.views / maxViews) * 100) : 0;
                    const bgColor = `rgba(0, 0, 0, ${0.3 + (intensity / 100) * 0.7})`;
                    return `
                      <div style="padding: 1em; background-color: ${bgColor}; color: #f4e8d4; border: 1px solid #000; text-align: center;">
                        <p style="font-weight: 700; margin-bottom: 0.5em; font-size: 0.9em;">${escapeHtml(getPageName(page.path))}</p>
                        <p style="font-size: 1.5em; font-weight: 700; margin: 0;">${page.views}</p>
                        <p style="font-size: 0.75em; margin-top: 0.25em; opacity: 0.9;">views</p>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              ` : ''}

              <!-- Content Performance -->
              ${contentRes?.top_pages?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Content Performance (Ranked by Engagement)</h4>
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 2px solid #000; background-color: rgba(244, 232, 212, 0.5);">
                      <th style="padding: 0.75em; text-align: left; font-weight: 700;">Page</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Views</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Avg Time</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Bounce</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${contentRes.top_pages.slice(0, 10).map((page, idx) => `
                      <tr style="border-bottom: 1px solid #ccc; ${idx < 3 ? 'background-color: rgba(0, 100, 0, 0.1);' : ''}">
                        <td style="padding: 0.75em;">${escapeHtml(getPageName(page.path))}</td>
                        <td style="padding: 0.75em; text-align: right;">${page.views}</td>
                        <td style="padding: 0.75em; text-align: right;">${Math.floor(page.avg_time / 60)}m ${page.avg_time % 60}s</td>
                        <td style="padding: 0.75em; text-align: right; color: ${page.bounce_rate < 50 ? '#006400' : page.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">${page.bounce_rate}%</td>
                        <td style="padding: 0.75em; text-align: right; font-weight: 700;">${page.engagement_score}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                ${contentRes.editions?.length > 0 ? `
                <div style="margin-top: 2em;">
                  <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Archive Edition Performance</h5>
                  <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                      <tr style="border-bottom: 2px solid #000;">
                        <th style="padding: 0.5em; text-align: left; font-weight: 700;">Edition</th>
                        <th style="padding: 0.5em; text-align: right; font-weight: 700;">Views</th>
                        <th style="padding: 0.5em; text-align: right; font-weight: 700;">Avg Time</th>
                        <th style="padding: 0.5em; text-align: right; font-weight: 700;">Bounce</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${contentRes.editions.slice(0, 5).map(edition => `
                        <tr style="border-bottom: 1px solid #ccc;">
                          <td style="padding: 0.5em;">${edition.date}</td>
                          <td style="padding: 0.5em; text-align: right;">${edition.views}</td>
                          <td style="padding: 0.5em; text-align: right;">${Math.floor(edition.avg_time / 60)}m ${edition.avg_time % 60}s</td>
                          <td style="padding: 0.5em; text-align: right; color: ${edition.bounce_rate < 50 ? '#006400' : edition.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">${edition.bounce_rate}%</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                ` : ''}
              </div>
              ` : ''}

              <!-- User Journey -->
              ${journeyRes?.entry_pages?.length > 0 || journeyRes?.exit_pages?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">User Journey</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Entry Pages (Where Users Land)</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                      <thead>
                        <tr style="border-bottom: 2px solid #000;">
                          <th style="padding: 0.5em; text-align: left; font-weight: 700;">Page</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">%</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${journeyRes.entry_pages.slice(0, 5).map(entry => `
                          <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 0.5em;">${escapeHtml(getPageName(entry.path))}</td>
                            <td style="padding: 0.5em; text-align: right;">${entry.percentage}%</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Exit Pages (Where Users Leave)</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                      <thead>
                        <tr style="border-bottom: 2px solid #000;">
                          <th style="padding: 0.5em; text-align: left; font-weight: 700;">Page</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">Exit Rate</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${journeyRes.exit_rates?.slice(0, 5).map(exit => `
                          <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 0.5em;">${escapeHtml(getPageName(exit.path))}</td>
                            <td style="padding: 0.5em; text-align: right; color: ${exit.exit_rate > 70 ? '#8b0000' : exit.exit_rate > 50 ? '#8b4513' : '#006400'};">${exit.exit_rate}%</td>
                          </tr>
                        `).join('') || '<tr><td colspan="2" style="padding: 0.5em; text-align: center; color: #666;">No exit data</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              ` : ''}


              <!-- Device Types and Top Countries side by side (3 & 4) -->
              <!-- Device Types -->
              ${devicesRes?.devices?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Device Types</h4>
                <canvas id="deviceTypesChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              ${!pageviewsRes && !visitorsRes ? `
              <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <p style="font-size: 0.9em; color: #666;">
                  No analytics data available yet. Data will appear here once visitors start using the site.
                </p>
              </div>
              ` : ''}
            `;

            metricsEl.innerHTML = html;
            
            // Store data globally for filtering functionality
            window.currentAnalyticsData = {
              timeline: timelineRes || null,
              growth: growthRes || null,
              engagement: engagementRes || null,
              sources: sourcesRes || null,
              content: contentRes || null,
              journey: journeyRes || null,
              period: period,
              token: token
            };
            window.timelineState = {
              level: 'months', // 'months', 'days', 'hours'
              selectedMonth: null,
              selectedDay: null
            };
            // Store original timeline data for navigation
            window.originalTimelineData = timelineRes || null;
            
            // Render charts after HTML is inserted (in order)
            if (pageviewsRes?.daily?.length > 0) {
              renderTrafficTrendChart(pageviewsRes.daily);
            }
            if (timelineRes?.months?.length > 0) {
              // Store original timeline data
              window.originalTimelineData = timelineRes;
              window.timelineState = {
                level: 'months',
                selectedMonth: null,
                selectedDay: null
              };
              // Initialize timeline with months view
              renderTimelineChart(timelineRes, 'months', null, null);
            }
            if (timelineRes?.day_of_week?.length > 0) {
              renderDayOfWeekChart(timelineRes.day_of_week);
            }
            if (engagementRes?.time_distribution) {
              renderTimeDistributionChart(engagementRes.time_distribution);
            }
            if (engagementRes?.pages_per_session?.distribution) {
              renderPagesPerSessionChart(engagementRes.pages_per_session.distribution);
            }
            if (sourcesRes?.categories?.length > 0) {
              renderSourcesPieChart(sourcesRes.categories);
            }
            if (devicesRes?.devices?.length > 0) {
              renderDeviceTypesChart(devicesRes.devices);
            }
          } catch (err) {
            console.error("Error loading site metrics:", err);
            metricsEl.innerHTML = `
              <p><strong>Site Analytics</strong></p>
              <p style="color: darkred;">Error loading analytics information. Check console for details.</p>
              <p style="font-size: 0.85em; color: #666; margin-top: 0.5em;">
                Error: ${escapeHtml(err.message || 'Unknown error')}
              </p>
            `;
          }
        }

        // Render Device Types bar chart
        function renderDeviceTypesChart(data) {
          // Destroy existing chart if it exists
          if (window.deviceTypesChartInstance) {
            window.deviceTypesChartInstance.destroy();
          }

          const ctx = document.getElementById('deviceTypesChart');
          if (!ctx) return;

          // Reverse data for horizontal bar chart (top to bottom)
          const reversedData = [...data].reverse();
          const labels = reversedData.map(device => {
            const type = device.type || 'desktop';
            return type.charAt(0).toUpperCase() + type.slice(1);
          });
          const values = reversedData.map(device => device.count);
          const maxValue = values.length ? Math.max(...values) : 0;
          const xMax = maxValue === 0 ? 1 : maxValue + Math.ceil(maxValue * 0.1);

          window.deviceTypesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Views',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal bar chart
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 11,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: xMax,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Time on Page bar chart
        function renderTimeOnPageChart(data) {
          // This function is kept for backwards compatibility but no longer used
          // The Average Time on Page chart has been replaced with a detailed visits table.
          return;
        }


        // Drill down to days for a selected month
        async function drillDownToDays(month) {
          const analyticsData = window.currentAnalyticsData;
          if (!analyticsData || !analyticsData.token) {
            console.error('Analytics data not available');
            return;
          }

          try {
            const period = analyticsData.period || '7d';
            const response = await fetch(`/api/analytics-data?metric=timeline&period=${period}&month=${month}`, {
              headers: { 'Authorization': `Bearer ${analyticsData.token}` }
            });

            if (response.ok) {
              const data = await response.json();
              window.timelineState.level = 'days';
              window.timelineState.selectedMonth = month;
              renderTimelineChart(data, 'days', month, null);
            } else {
              console.error('Failed to fetch days data');
            }
          } catch (error) {
            console.error('Error drilling down to days:', error);
          }
        }

        // Drill down to hours for a selected day
        async function drillDownToHours(day, month) {
          const analyticsData = window.currentAnalyticsData;
          if (!analyticsData || !analyticsData.token) {
            console.error('Analytics data not available');
            return;
          }

          try {
            const period = analyticsData.period || '7d';
            const response = await fetch(`/api/analytics-data?metric=timeline&period=${period}&month=${month}&day=${day}`, {
              headers: { 'Authorization': `Bearer ${analyticsData.token}` }
            });

            if (response.ok) {
              const data = await response.json();
              window.timelineState.level = 'hours';
              window.timelineState.selectedDay = day;
              renderTimelineChart(data, 'hours', month, day);
            } else {
              console.error('Failed to fetch hours data');
            }
          } catch (error) {
            console.error('Error drilling down to hours:', error);
          }
        }

        // Go back in timeline hierarchy
        async function goBackTimeline() {
          const state = window.timelineState;
          const analyticsData = window.currentAnalyticsData;
          
          if (state.level === 'days') {
            // Go back to months
            if (window.originalTimelineData) {
              window.timelineState.level = 'months';
              window.timelineState.selectedMonth = null;
              renderTimelineChart(window.originalTimelineData, 'months', null, null);
            } else {
              // Reload from API
              try {
                const period = analyticsData.period || '7d';
                const token = analyticsData.token;
                const response = await fetch(`/api/analytics-data?metric=timeline&period=${period}`, {
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                  const data = await response.json();
                  window.originalTimelineData = data;
                  window.timelineState.level = 'months';
                  window.timelineState.selectedMonth = null;
                  renderTimelineChart(data, 'months', null, null);
                }
              } catch (error) {
                console.error('Error reloading timeline:', error);
              }
            }
          } else if (state.level === 'hours') {
            // Go back to days
            if (state.selectedMonth) {
              await drillDownToDays(state.selectedMonth);
            }
          }
        }

        function renderTimelineChart(data, level, selectedMonth = null, selectedDay = null) {
          // Destroy existing chart if it exists
          if (window.timelineChartInstance) {
            window.timelineChartInstance.destroy();
          }

          const ctx = document.getElementById('timelineChart');
          if (!ctx) return;

          let labels = [];
          let values = [];

          if (level === 'months') {
            if (!data.months || data.months.length === 0) {
              labels = ['No data'];
              values = [0];
            } else {
              labels = data.months.map(m => m.label);
              values = data.months.map(m => m.count);
            }
          } else if (level === 'days') {
            if (!data.days || data.days.length === 0) {
              labels = ['No data'];
              values = [0];
            } else {
              // Use the label from API which is already in CST, or format manually
              labels = data.days.map(d => {
                if (d.label) return d.label;
                // Format manually using CST date
                const [year, month, day] = d.day.split('-');
                const date = new Date(year, parseInt(month) - 1, parseInt(day));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
              });
              values = data.days.map(d => d.count);
            }
          } else if (level === 'hours') {
            // Aggregate all hours across all days
            const hourCounts = {};
            for (let i = 0; i < 24; i++) {
              hourCounts[i] = 0;
            }
            if (data.hours && data.hours.length > 0) {
              data.hours.forEach(h => {
                hourCounts[h.hour] = (hourCounts[h.hour] || 0) + h.count;
              });
            }
            for (let i = 0; i < 24; i++) {
              const period = i >= 12 ? 'PM' : 'AM';
              const displayHour = i === 0 ? 12 : i > 12 ? i - 12 : i;
              labels.push(`${displayHour} ${period}`);
              values.push(hourCounts[i] || 0);
            }
          }

          // Update breadcrumb and back button
          const indicator = document.getElementById('timeline-level-indicator');
          const backBtn = document.getElementById('timeline-back-btn');
          
          if (level === 'months') {
            if (indicator) indicator.textContent = 'Viewing: Months (click a bar to drill down)';
            if (backBtn) backBtn.style.display = 'none';
          } else if (level === 'days') {
            let monthLabel = 'selected month';
            if (selectedMonth) {
              const parts = selectedMonth.split('-');
              if (parts.length === 2) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const date = new Date(year, month, 1);
                monthLabel = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
              }
            }
            if (indicator) indicator.textContent = `Viewing: Days in ${monthLabel} (click a bar to drill down)`;
            if (backBtn) backBtn.style.display = 'inline-block';
          } else if (level === 'hours') {
            let dayLabel = 'selected day';
            if (selectedDay) {
              // selectedDay is in YYYY-MM-DD format
              const parts = selectedDay.split('-');
              if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                const day = parseInt(parts[2]);
                // Create date in local timezone (not UTC) to avoid timezone shifts
                const date = new Date(year, month, day);
                // Format with ordinal (1st, 2nd, 3rd, etc.)
                const dayNum = date.getDate();
                const suffix = dayNum === 1 || dayNum === 21 || dayNum === 31 ? 'st' :
                              dayNum === 2 || dayNum === 22 ? 'nd' :
                              dayNum === 3 || dayNum === 23 ? 'rd' : 'th';
                dayLabel = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                // Replace the numeric day with ordinal version
                dayLabel = dayLabel.replace(/\b(\d+)\b/, `$1${suffix}`);
              }
            }
            if (indicator) indicator.textContent = `Viewing: Hours on ${dayLabel}`;
            if (backBtn) backBtn.style.display = 'inline-block';
          }

          const chartConfig = {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Visits',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'x', // Vertical bars
              responsive: true,
              maintainAspectRatio: true,
              onClick: async function(event, elements) {
                if (elements.length > 0 && level !== 'hours') {
                  const clickedIndex = elements[0].index;
                  
                  if (level === 'months') {
                    // Drill down to days
                    const selectedMonth = data.months[clickedIndex].month;
                    await drillDownToDays(selectedMonth);
                  } else if (level === 'days') {
                    // Drill down to hours
                    const selectedDay = data.days[clickedIndex].day;
                    await drillDownToHours(selectedDay, selectedMonth);
                  }
                }
              },
              onHover: function(event, elements) {
                event.native.target.style.cursor = (level !== 'hours' && elements.length > 0) ? 'pointer' : 'default';
              },
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 13,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    maxRotation: level === 'hours' ? 0 : 45,
                    minRotation: level === 'hours' ? 0 : 45
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  beginAtZero: true,
                  max: (function() {
                    const maxValue = values.length ? Math.max(...values) : 0;
                    return maxValue === 0 ? 1 : maxValue + Math.ceil(maxValue * 0.1);
                  })(),
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 13
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            },
            plugins: [ChartDataLabels]
          };

          window.timelineChartInstance = new Chart(ctx, chartConfig);
        }

        // Old drill-down functions removed - replaced by switchTimelineView button selector

        // Render Traffic Trend Chart (Daily with comparison)
        function renderTrafficTrendChart(dailyData) {
          if (window.trafficTrendChartInstance) {
            window.trafficTrendChartInstance.destroy();
          }

          const ctx = document.getElementById('trafficTrendChart');
          if (!ctx) return;

          // Format dates for labels (dates are already in CST from API)
          const labels = dailyData.map(item => {
            // item.date is YYYY-MM-DD format in CST
            const [year, month, day] = item.date.split('-');
            const date = new Date(year, parseInt(month) - 1, parseInt(day));
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          });
          const values = dailyData.map(item => item.count);
          const maxValue = values.length ? Math.max(...values) : 0;
          const yMax = maxValue === 0 ? 1 : maxValue + Math.ceil(maxValue * 0.1);

          window.trafficTrendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Page Views',
                data: values,
                borderColor: '#000',
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#000',
                pointBorderColor: '#f4e8d4',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 10,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    maxRotation: 45,
                    minRotation: 45
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  beginAtZero: true,
                  max: yMax,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        }

        // Render Day of Week Chart
        function renderDayOfWeekChart(dayData) {
          if (window.dayOfWeekChartInstance) {
            window.dayOfWeekChartInstance.destroy();
          }

          const ctx = document.getElementById('dayOfWeekChart');
          if (!ctx) return;

          const labels = dayData.map(d => d.day);
          const values = dayData.map(d => d.count);
          const maxValue = values.length ? Math.max(...values) : 0;
          const yMax = maxValue === 0 ? 1 : maxValue + Math.ceil(maxValue * 0.1);

          window.dayOfWeekChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Visits',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 11,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  beginAtZero: true,
                  max: yMax,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        }

        // Render Time Distribution Chart
        function renderTimeDistributionChart(distribution) {
          if (window.timeDistributionChartInstance) {
            window.timeDistributionChartInstance.destroy();
          }

          const ctx = document.getElementById('timeDistributionChart');
          if (!ctx) return;

          const labels = Object.keys(distribution);
          const values = Object.values(distribution);
          const total = values.reduce((a, b) => a + b, 0);
          const percentages = values.map(v => total > 0 ? Math.round((v / total) * 100) : 0);

          window.timeDistributionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Visitors',
                data: percentages,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 13,
                    weight: 'bold'
                  },
                  formatter: function(value, context) {
                    const index = context.dataIndex;
                    return `${percentages[index]}%`;
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    callback: function(value) {
                      return value + '%';
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Pages per Session Chart
        function renderPagesPerSessionChart(distribution) {
          if (window.pagesPerSessionChartInstance) {
            window.pagesPerSessionChartInstance.destroy();
          }

          const ctx = document.getElementById('pagesPerSessionChart');
          if (!ctx) return;

          const labels = Object.keys(distribution);
          const values = Object.values(distribution);
          const total = values.reduce((a, b) => a + b, 0);
          const percentages = values.map(v => total > 0 ? Math.round((v / total) * 100) : 0);

          window.pagesPerSessionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels.map(l => l === '1' ? '1 page' : l === '2-3' ? '2-3 pages' : l === '4-5' ? '4-5 pages' : '6+ pages'),
              datasets: [{
                label: 'Sessions',
                data: percentages,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 13,
                    weight: 'bold'
                  },
                  formatter: function(value, context) {
                    const index = context.dataIndex;
                    return `${percentages[index]}%`;
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    callback: function(value) {
                      return value + '%';
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Traffic Sources Pie Chart
        function renderSourcesPieChart(categories) {
          if (window.sourcesPieChartInstance) {
            window.sourcesPieChartInstance.destroy();
          }

          const ctx = document.getElementById('sourcesPieChart');
          if (!ctx) return;

          const labels = categories.map(c => c.name);
          const values = categories.map(c => c.count);
          const colors = ['#000', '#333', '#666', '#999'];

          window.sourcesPieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: values,
                backgroundColor: [
                  'rgba(0, 0, 0, 0.8)',
                  'rgba(0, 0, 0, 0.6)',
                  'rgba(0, 0, 0, 0.4)',
                  'rgba(0, 0, 0, 0.2)'
                ],
                borderColor: '#000',
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    padding: 15
                  }
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  color: '#fff',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 14,
                    weight: 'bold'
                  },
                  formatter: function(value, context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                    return percentage > 5 ? `${percentage}%` : ''; // Only show if > 5%
                  }
                }
              }
            }
          });
        }

        // Reset all analytics data
        async function resetAnalyticsData() {
          if (!confirm('Are you sure you want to delete ALL analytics data? This cannot be undone.')) {
            return;
          }

          if (!confirm('This will permanently delete all page views, visitor sessions, and rate limit data. Continue?')) {
            return;
          }

          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              alert('Please sign in to reset data.');
              return;
            }

            const token = session.access_token;
            const response = await fetch('/api/reset-analytics', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });

            if (response.ok) {
              const result = await response.json();
              alert('All analytics data has been reset successfully. The dashboard will refresh.');
              // Reload metrics
              loadSiteMetrics();
            } else {
              const error = await response.json();
              alert('Error resetting data: ' + (error.error || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error resetting analytics:', error);
            alert('Error resetting data. Check console for details.');
          }
        }
      </script>
    </div>
    <!-- Page footer -->
    <div style="max-width: 800px; margin: 0 auto; padding: 0 20px">
      <img src="images/divider.png" alt="divider" class="divider" />
      <nav style="text-align: center; margin: 1em 0">
        <ul>
          <li>
            <a href="index.html">
              <span class="nav-initial">H</span
              ><span class="nav-word">ome</span>
            </a>
          </li>
          <li>
            <a href="about.html">
              <span class="nav-initial">A</span
              ><span class="nav-word">bout</span>
            </a>
          </li>
          <li>
            <a href="submit.html">
              <span class="nav-initial">S</span
              ><span class="nav-word">ubmit</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="page-footer">
        <p style="text-align: center; margin-bottom: 0.5em">
          &copy; 2026 The Watchman's Cry: Common Sense Reborn
        </p>
        RSJr. For the Republic.
      </div>
    </div>
  </body>
</html>

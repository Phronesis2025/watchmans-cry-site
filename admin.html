<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchman Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>The Watchman's Cry – Admin Only</h1>
        <img src="images/divider.png" alt="divider" class="divider" />
      </header>

      <div id="login" style="text-align: center; margin: 4em 0">
        <h3>Admin Access</h3>
        <input type="password" id="admin-pass" placeholder="Enter passphrase" />
        <button onclick="checkAdmin()">Enter</button>
      </div>

      <div id="admin-content" style="display: none">
        <h2>Submissions</h2>

        <h3>Counsel Questions</h3>
        <div id="counsel-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Site Metrics</h3>
        <div id="vercel-metrics" style="margin-bottom: 2em">
          <p>Loading Vercel Analytics...</p>
        </div>
      </div>

      <script>
        const REAL_PASSWORD = "jasonboyer"; // CHANGE THIS!

        function checkAdmin() {
          const pass = document.getElementById("admin-pass").value;
          if (pass === REAL_PASSWORD) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            loadSubmissions();
          } else {
            alert("Access denied.");
          }
        }

        async function loadSubmissions() {
          // Load counsel questions data
          const counselEl = document.getElementById("counsel-data");
          counselEl.innerHTML = "<p>Loading counsel questions...</p>";

          try {
            console.log(
              "Attempting to load counsel questions from Supabase..."
            );
            const { data: counsel, error: counselError } = await supabaseClient
              .from("counsel_questions")
              .select("*")
              .order("created_at", { ascending: false });

            console.log("Supabase response:", {
              data: counsel,
              error: counselError,
            });

            if (counselError) {
              console.error("Supabase error:", counselError);
              counselEl.innerHTML = `
                <p style="color: darkred;"><strong>Error:</strong> ${counselError.message}</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                  <strong>Note:</strong> This is likely a Row Level Security (RLS) policy issue. 
                  To fix this, you need to:
                  <ol style="margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Go to your Supabase dashboard</li>
                    <li>Navigate to Authentication → Policies for the "counsel_questions" table</li>
                    <li>Create a policy that allows SELECT operations (or temporarily disable RLS for testing)</li>
                    <li>Alternatively, use a service_role key server-side (never expose this in client code)</li>
                  </ol>
                  <p style="margin-top: 0.5em;">
                    <strong>Debug info:</strong> Check browser console (F12) for detailed error information.
                  </p>
                </p>
              `;
            } else if (!counsel || counsel.length === 0) {
              counselEl.innerHTML = "<p>No counsel questions yet.</p>";
            } else {
              console.log(`Loaded ${counsel.length} counsel questions`);
              let html = `<p><strong>Total: ${counsel.length} questions</strong></p>`;
              counsel.forEach((entry, index) => {
                const date = entry.created_at
                  ? new Date(entry.created_at).toLocaleDateString()
                  : "Date unknown";
                html += `<div style="border: 1px solid #000; padding: 1em; margin: 1em 0;">`;
                html += `<p><strong>Question ${
                  index + 1
                }</strong> - ${date}</p>`;
                if (entry.name)
                  html += `<p><strong>Name:</strong> ${entry.name}</p>`;
                if (entry.profession)
                  html += `<p><strong>Profession:</strong> ${entry.profession}</p>`;
                if (entry.state)
                  html += `<p><strong>State:</strong> ${entry.state}</p>`;
                html += `<p><strong>Question:</strong> ${
                  entry.question || "No question text"
                }</p>`;
                html += `</div>`;
              });
              counselEl.innerHTML = html;
            }
          } catch (err) {
            console.error("Exception loading counsel questions:", err);
            counselEl.innerHTML = `
              <p style="color: darkred;"><strong>Error loading counsel questions:</strong> ${err.message}</p>
              <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                Check browser console (F12) for more details.
              </p>
            `;
          }

          // Load Vercel Analytics
          loadVercelMetrics();
        }

        function loadVercelMetrics() {
          const metricsEl = document.getElementById("vercel-metrics");

          // Vercel Analytics is automatically enabled for deployed projects
          // For static HTML sites, analytics are collected server-side
          metricsEl.innerHTML = `
            <p><strong>Vercel Analytics</strong></p>
            <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
              Vercel automatically collects analytics for all deployed projects. 
              View detailed metrics including page views, unique visitors, top pages, 
              and more in your Vercel Dashboard.
            </p>
            <p style="margin-top: 1em;">
              <a href="https://vercel.com/dashboard" target="_blank" style="color: #000; text-decoration: underline; font-weight: 700;">
                Open Vercel Dashboard →
              </a>
            </p>
            <p style="font-size: 0.85em; color: #666; margin-top: 1em; font-style: italic;">
              Note: Analytics data is available in your project's Analytics tab after deployment. 
              Real-time metrics may take a few minutes to appear.
            </p>
          `;
        }
      </script>
    </div>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchman Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <!-- Chart.js for bar charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>The Watchman's Cry – Admin Only</h1>
        <img src="images/divider.png" alt="divider" class="divider" />
      </header>

      <div id="login" style="text-align: center; margin: 4em 0">
        <h3>Admin Access</h3>
        <div id="login-form" style="max-width: 400px; margin: 0 auto">
          <input
            type="email"
            id="admin-email"
            placeholder="Email"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <input
            type="password"
            id="admin-password"
            placeholder="Password"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <button
            onclick="signIn()"
            style="
              padding: 0.75em 2em;
              background-color: #000;
              color: #f4e8d4;
              border: none;
              font-family: 'EB Garamond', serif;
              font-size: 1em;
              font-weight: 700;
              cursor: pointer;
              width: 100%;
            "
          >
            Sign In
          </button>
          <p
            id="login-error"
            style="color: darkred; margin-top: 1em; display: none"
          ></p>
        </div>
        <!-- Signup disabled for security - accounts must be created through Supabase dashboard -->
        <p
          id="signup-info"
          style="font-size: 0.9em; color: #666; margin-top: 1em; display: none"
        >
          Admin accounts must be created through the Supabase dashboard for
          security.
        </p>
      </div>

      <div id="admin-content" style="display: none">
        <h2>Submissions</h2>

        <h3>Counsel Questions</h3>
        <div id="counsel-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Site Metrics</h3>
        <div id="site-metrics" style="margin-bottom: 2em">
          <p>Loading site metrics...</p>
        </div>
      </div>

      <script>
        // Security: HTML escaping function to prevent XSS attacks
        function escapeHtml(text) {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        // Helper: Format seconds to "Xm Ys" format
        function formatTime(seconds) {
          if (!seconds || seconds === 0) return '0s';
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          if (minutes > 0) {
            return `${minutes}m ${secs}s`;
          }
          return `${secs}s`;
        }

        // Convert page path to common name
        function getPageName(path) {
          const pageNames = {
            '/': 'Home',
            '/index.html': 'Home',
            '/about.html': 'About',
            '/submit.html': 'Submit',
            '/staff.html': 'Voices',
            '/archive.html': 'Archive',
            '/privacy-policy.html': 'Privacy Policy',
            '/test-analytics.html': 'Test Analytics',
            '/admin.html': 'Admin',
            '/prelaunch.html': 'Prelaunch'
          };
          
          // Check exact match first
          if (pageNames[path]) {
            return pageNames[path];
          }
          
          // Check if it's an archive edition
          if (path.startsWith('/archive/')) {
            const match = path.match(/edition-(\d{4}-\d{2}-\d{2})/);
            if (match) {
              return `Edition ${match[1]}`;
            }
            return 'Archive Edition';
          }
          
          // Fallback: return path without leading slash
          return path.replace(/^\//, '') || 'Home';
        }

        // Check if user is already signed in on page load
        window.addEventListener("DOMContentLoaded", async () => {
          const {
            data: { session },
          } = await supabaseClient.auth.getSession();
          if (session) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            loadSubmissions();
          }
        });

        // Signup function removed for security - accounts must be created via Supabase dashboard

        async function signIn() {
          const email = document.getElementById("admin-email").value;
          const password = document.getElementById("admin-password").value;
          const errorEl = document.getElementById("login-error");

          if (!email || !password) {
            errorEl.textContent = "Please enter both email and password.";
            errorEl.style.display = "block";
            return;
          }

          errorEl.style.display = "none";

          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            // Security: Don't expose detailed error messages that could help attackers
            errorEl.textContent =
              "Invalid email or password. Please try again.";
            errorEl.style.display = "block";
            return;
          }

          // Success - hide login, show admin content
          document.getElementById("login").style.display = "none";
          document.getElementById("admin-content").style.display = "block";
          loadSubmissions();
        }

        // Signup function removed for security - prevent unauthorized account creation

        async function loadSubmissions() {
          // Load counsel questions data
          const counselEl = document.getElementById("counsel-data");
          counselEl.innerHTML = "<p>Loading counsel questions...</p>";

          try {
            console.log(
              "Attempting to load counsel questions from Supabase..."
            );
            const { data: counsel, error: counselError } = await supabaseClient
              .from("counsel_questions")
              .select("*")
              .order("created_at", { ascending: false });

            console.log("Supabase response:", {
              data: counsel,
              error: counselError,
            });

            if (counselError) {
              console.error("Supabase error:", counselError);
              counselEl.innerHTML = `
                <p style="color: darkred;"><strong>Error:</strong> ${escapeHtml(
                  counselError.message
                )}</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                  <strong>Note:</strong> This is likely a Row Level Security (RLS) policy issue. 
                  To fix this, you need to:
                  <ol style="margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Go to your Supabase dashboard</li>
                    <li>Navigate to Authentication → Policies for the "counsel_questions" table</li>
                    <li>Create a policy that allows SELECT operations (or temporarily disable RLS for testing)</li>
                    <li>Alternatively, use a service_role key server-side (never expose this in client code)</li>
                  </ol>
                  <p style="margin-top: 0.5em;">
                    <strong>Debug info:</strong> Check browser console (F12) for detailed error information.
                  </p>
                </p>
              `;
            } else if (!counsel || counsel.length === 0) {
              counselEl.innerHTML = "<p>No counsel questions yet.</p>";
            } else {
              console.log(`Loaded ${counsel.length} counsel questions`);
              let html = `<p><strong>Total: ${counsel.length} questions</strong></p>`;
              html += `<table style="width: 100%; border-collapse: collapse; margin-top: 1em; border: 1px solid #000;">`;
              html += `<thead>`;
              html += `<tr style="background-color: rgba(244, 232, 212, 0.5); border-bottom: 2px solid #000;">`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Date</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Name</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Profession</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">State</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Question</th>`;
              html += `</tr>`;
              html += `</thead>`;
              html += `<tbody>`;
              counsel.forEach((entry) => {
                const date = entry.created_at
                  ? new Date(entry.created_at).toLocaleDateString()
                  : "Date unknown";
                html += `<tr style="border-bottom: 1px solid #000;">`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  date
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.name || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.profession || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.state || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.question || "No question text"
                )}</td>`;
                html += `</tr>`;
              });
              html += `</tbody>`;
              html += `</table>`;
              counselEl.innerHTML = html;
            }
          } catch (err) {
            console.error("Exception loading counsel questions:", err);
            counselEl.innerHTML = `
              <p style="color: darkred;"><strong>Error loading counsel questions:</strong> ${escapeHtml(
                err.message
              )}</p>
              <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                Check browser console (F12) for more details.
              </p>
            `;
          }

          // Load Site Metrics (Supabase Analytics)
          loadSiteMetrics();
        }

        async function loadSiteMetrics() {
          const metricsEl = document.getElementById("site-metrics");
          metricsEl.innerHTML = "<p>Loading site metrics...</p>";

          try {
            // Get current session token
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              metricsEl.innerHTML = `
                <p><strong>Site Analytics</strong></p>
                <p style="color: darkred;">Please sign in to view analytics.</p>
              `;
              return;
            }

            // Get selected period from dropdown or default to 7d
            const periodSelect = document.getElementById('analytics-period');
            const period = periodSelect ? periodSelect.value : '7d';
            const token = session.access_token;

            const [pageviewsRes, visitorsRes, devicesRes, timeonpageRes, hourlyRes, timelineRes, growthRes, engagementRes, sourcesRes, contentRes, journeyRes] = await Promise.all([
              fetch(`/api/analytics-data?metric=pageviews&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=visitors&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=devices&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=timeonpage&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=hourly&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=timeline&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=growth&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=engagement&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=sources&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=content&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=journey&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null)
            ]);

            let html = `
              <p><strong>Site Analytics</strong></p>
              <div style="margin-bottom: 1em; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5em;">
                <div>
                  <label style="font-weight: 700; margin-right: 0.5em;">Time Period:</label>
                  <select id="analytics-period" onchange="loadSiteMetrics()" style="padding: 0.25em; border: 1px solid #000; font-family: 'EB Garamond', serif;">
                    <option value="7d" ${period === '7d' ? 'selected' : ''}>Last 7 days</option>
                    <option value="30d" ${period === '30d' ? 'selected' : ''}>Last 30 days</option>
                    <option value="all" ${period === 'all' ? 'selected' : ''}>All time</option>
                  </select>
                  <button onclick="loadSiteMetrics()" style="margin-left: 0.5em; padding: 0.25em 0.75em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer;">Refresh</button>
                </div>
                <button onclick="resetAnalyticsData()" style="padding: 0.25em 0.75em; background-color: #8b0000; color: #f4e8d4; border: 1px solid #8b0000; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.9em;" title="Delete all analytics data and start fresh">Reset All Data</button>
              </div>
              
              <!-- Enhanced KPI Cards with Trends -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1em; margin-bottom: 2em;">
                <!-- Page Views Card with Growth -->
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Total Page Views</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0;">${pageviewsRes?.total || 0}</p>
                  ${growthRes?.pageviews ? `
                    <p style="font-size: 0.85em; margin-top: 0.5em; color: ${growthRes.pageviews.change > 0 ? '#006400' : growthRes.pageviews.change < 0 ? '#8b0000' : '#666'};">
                      ${growthRes.pageviews.change > 0 ? '↗️' : growthRes.pageviews.change < 0 ? '↘️' : '→'} 
                      ${Math.abs(growthRes.pageviews.change)}% vs previous period
                    </p>
                    <p style="font-size: 0.75em; color: #666; margin-top: 0.25em;">Trend: ${growthRes.pageviews.trend === 'up' ? 'Growing' : growthRes.pageviews.trend === 'down' ? 'Declining' : 'Stable'}</p>
                  ` : ''}
                  <p style="font-size: 0.7em; color: #666; margin-top: 0.5em; font-style: italic;">Total number of pages viewed. Shows overall site traffic and content consumption.</p>
                </div>
                
                <!-- Unique Visitors Card with Return Rate -->
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Unique Visitors</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0;">${visitorsRes?.unique_visitors || 0}</p>
                  ${growthRes?.visitors ? `
                    <p style="font-size: 0.85em; margin-top: 0.5em; color: ${growthRes.visitors.change > 0 ? '#006400' : growthRes.visitors.change < 0 ? '#8b0000' : '#666'};">
                      ${growthRes.visitors.change > 0 ? '↗️' : growthRes.visitors.change < 0 ? '↘️' : '→'} 
                      ${Math.abs(growthRes.visitors.change)}% vs previous
                    </p>
                  ` : ''}
                  ${engagementRes?.return_rate !== undefined ? `
                    <p style="font-size: 0.75em; color: #666; margin-top: 0.25em;">${engagementRes.return_rate}% returning</p>
                  ` : ''}
                  <p style="font-size: 0.7em; color: #666; margin-top: 0.5em; font-style: italic;">Distinct individuals visiting your site. Higher numbers indicate growing audience reach.</p>
                </div>
                
                <!-- Engagement Card (New) -->
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Engagement Quality</p>
                  ${engagementRes ? `
                    <p style="font-size: 1.5em; font-weight: 700; margin: 0; color: ${engagementRes.bounce_rate < 50 ? '#006400' : engagementRes.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">
                      ${engagementRes.bounce_rate}% bounce
                    </p>
                    <p style="font-size: 0.75em; color: #666; margin-top: 0.25em;">
                      ${engagementRes.pages_per_session?.average || 0} pages/session
                    </p>
                  ` : '<p style="font-size: 1.5em; font-weight: 700; margin: 0;">-</p>'}
                  <p style="font-size: 0.7em; color: #666; margin-top: 0.5em; font-style: italic;">Bounce rate shows single-page visits. Lower is better—indicates visitors explore multiple pages.</p>
                </div>
                
                <!-- Time on Page Card Enhanced -->
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Avg. Time on Page</p>
                  ${timeonpageRes?.overall_average ? `
                    <p style="font-size: 2em; font-weight: 700; margin: 0;">
                      ${Math.floor(timeonpageRes.overall_average / 60)}m ${timeonpageRes.overall_average % 60}s
                    </p>
                  ` : '<p style="font-size: 2em; font-weight: 700; margin: 0;">0s</p>'}
                  ${growthRes?.time_on_page ? `
                    <p style="font-size: 0.85em; margin-top: 0.5em; color: ${growthRes.time_on_page.change > 0 ? '#006400' : growthRes.time_on_page.change < 0 ? '#8b0000' : '#666'};">
                      ${growthRes.time_on_page.change > 0 ? '↗️' : growthRes.time_on_page.change < 0 ? '↘️' : '→'} 
                      ${Math.abs(growthRes.time_on_page.change)}%
                    </p>
                  ` : ''}
                  ${engagementRes?.time_distribution ? `
                    <p style="font-size: 0.75em; color: #666; margin-top: 0.25em;">
                      ${Math.round(((engagementRes.time_distribution['2-5min'] + engagementRes.time_distribution['5min+']) / 
                        (engagementRes.time_distribution['0-30s'] + engagementRes.time_distribution['30s-1min'] + 
                         engagementRes.time_distribution['1-2min'] + engagementRes.time_distribution['2-5min'] + 
                         engagementRes.time_distribution['5min+']) * 100) || 0)}% read 2+ min
                    </p>
                  ` : ''}
                  <p style="font-size: 0.7em; color: #666; margin-top: 0.5em; font-style: italic;">Average time visitors spend reading (only counts when tab is visible). Higher indicates deeper engagement.</p>
                </div>
              </div>

              <!-- Traffic Trend Chart (Daily with Comparison) -->
              ${pageviewsRes?.daily?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Traffic Trend (Daily Page Views)</h4>
                <canvas id="trafficTrendChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              <!-- Visitor Activity Timeline Chart (Vertical Bar with Button Selector) -->
              ${timelineRes?.months?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; flex-wrap: wrap; gap: 0.5em;">
                  <h4 style="margin: 0;">Visitor Activity Timeline</h4>
                  <div style="display: flex; gap: 0.5em;">
                    <button id="timeline-btn-months" onclick="switchTimelineView('months')" style="padding: 0.5em 1em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.9em;">Months</button>
                    <button id="timeline-btn-days" onclick="switchTimelineView('days')" style="padding: 0.5em 1em; background-color: #8b4513; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.9em;">Days</button>
                    <button id="timeline-btn-hours" onclick="switchTimelineView('hours')" style="padding: 0.5em 1em; background-color: #8b4513; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.9em;">Hours</button>
                  </div>
                </div>
                <canvas id="timelineChart" style="max-height: 500px;"></canvas>
                ${timelineRes?.peak_day || timelineRes?.peak_hour ? `
                <div style="margin-top: 1em; font-size: 0.9em; color: #666;">
                  ${timelineRes.peak_day ? `<p style="margin: 0.25em 0;"><strong>Peak Day:</strong> ${timelineRes.peak_day.day} (${timelineRes.peak_day.count} visits)</p>` : ''}
                  ${timelineRes.peak_hour ? `<p style="margin: 0.25em 0;"><strong>Peak Hour:</strong> ${timelineRes.peak_hour.label} (${timelineRes.peak_hour.count} visits)</p>` : ''}
                </div>
                ` : ''}
              </div>
              ` : ''}

              <!-- Day of Week Analysis -->
              ${timelineRes?.day_of_week?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Traffic by Day of Week</h4>
                <canvas id="dayOfWeekChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              <!-- Engagement Distribution Charts -->
              ${engagementRes ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Engagement Quality Metrics</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1em;">
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Time on Page Distribution</h5>
                    <canvas id="timeDistributionChart" style="max-height: 250px;"></canvas>
                  </div>
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Pages per Session</h5>
                    <canvas id="pagesPerSessionChart" style="max-height: 250px;"></canvas>
                  </div>
                </div>
                <div style="margin-top: 1em; padding: 1em; background-color: rgba(255, 255, 255, 0.2); border: 1px solid #000;">
                  <p style="margin: 0.25em 0;"><strong>Bounce Rate:</strong> ${engagementRes.bounce_rate}% ${engagementRes.bounce_rate < 50 ? '(Good)' : engagementRes.bounce_rate < 70 ? '(Fair)' : '(Needs Improvement)'}</p>
                  <p style="margin: 0.25em 0;"><strong>Return Visitor Rate:</strong> ${engagementRes.return_rate}%</p>
                  <p style="margin: 0.25em 0;"><strong>Avg Session Duration:</strong> ${Math.floor((engagementRes.session_duration?.average || 0) / 60)}m ${(engagementRes.session_duration?.average || 0) % 60}s</p>
                </div>
              </div>
              ` : ''}

              <!-- Traffic Sources -->
              ${sourcesRes?.categories?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Traffic Sources</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1em;">
                  <div>
                    <canvas id="sourcesPieChart" style="max-height: 300px;"></canvas>
                  </div>
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Top Referrers</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                      <thead>
                        <tr style="border-bottom: 2px solid #000;">
                          <th style="padding: 0.5em; text-align: left; font-weight: 700;">Source</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">Visits</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">Bounce</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${sourcesRes.top_referrers?.slice(0, 5).map(ref => `
                          <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 0.5em;">${escapeHtml(ref.domain)}</td>
                            <td style="padding: 0.5em; text-align: right;">${ref.count}</td>
                            <td style="padding: 0.5em; text-align: right; color: ${ref.bounce_rate < 50 ? '#006400' : ref.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">${ref.bounce_rate}%</td>
                          </tr>
                        `).join('') || '<tr><td colspan="3" style="padding: 0.5em; text-align: center; color: #666;">No referrer data</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              ` : ''}

              <!-- Page Sections Heatmap -->
              ${contentRes?.top_pages?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Page Sections Heatmap (Most Viewed Content)</h4>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">Visual representation of which pages and sections users view most. Darker colors indicate higher view counts.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1em;">
                  ${contentRes.top_pages.slice(0, 15).map(page => {
                    const maxViews = Math.max(...contentRes.top_pages.map(p => p.views));
                    const intensity = Math.round((page.views / maxViews) * 100);
                    const bgColor = `rgba(0, 0, 0, ${0.3 + (intensity / 100) * 0.7})`;
                    return `
                      <div style="padding: 1em; background-color: ${bgColor}; color: #f4e8d4; border: 1px solid #000; text-align: center;">
                        <p style="font-weight: 700; margin-bottom: 0.5em; font-size: 0.9em;">${escapeHtml(getPageName(page.path))}</p>
                        <p style="font-size: 1.5em; font-weight: 700; margin: 0;">${page.views}</p>
                        <p style="font-size: 0.75em; margin-top: 0.25em; opacity: 0.9;">views</p>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              ` : ''}

              <!-- Content Performance -->
              ${contentRes?.top_pages?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Content Performance (Ranked by Engagement)</h4>
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 2px solid #000; background-color: rgba(244, 232, 212, 0.5);">
                      <th style="padding: 0.75em; text-align: left; font-weight: 700;">Page</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Views</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Avg Time</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Bounce</th>
                      <th style="padding: 0.75em; text-align: right; font-weight: 700;">Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${contentRes.top_pages.slice(0, 10).map((page, idx) => `
                      <tr style="border-bottom: 1px solid #ccc; ${idx < 3 ? 'background-color: rgba(0, 100, 0, 0.1);' : ''}">
                        <td style="padding: 0.75em;">${escapeHtml(getPageName(page.path))}</td>
                        <td style="padding: 0.75em; text-align: right;">${page.views}</td>
                        <td style="padding: 0.75em; text-align: right;">${Math.floor(page.avg_time / 60)}m ${page.avg_time % 60}s</td>
                        <td style="padding: 0.75em; text-align: right; color: ${page.bounce_rate < 50 ? '#006400' : page.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">${page.bounce_rate}%</td>
                        <td style="padding: 0.75em; text-align: right; font-weight: 700;">${page.engagement_score}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                ${contentRes.editions?.length > 0 ? `
                <div style="margin-top: 2em;">
                  <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Archive Edition Performance</h5>
                  <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                      <tr style="border-bottom: 2px solid #000;">
                        <th style="padding: 0.5em; text-align: left; font-weight: 700;">Edition</th>
                        <th style="padding: 0.5em; text-align: right; font-weight: 700;">Views</th>
                        <th style="padding: 0.5em; text-align: right; font-weight: 700;">Avg Time</th>
                        <th style="padding: 0.5em; text-align: right; font-weight: 700;">Bounce</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${contentRes.editions.slice(0, 5).map(edition => `
                        <tr style="border-bottom: 1px solid #ccc;">
                          <td style="padding: 0.5em;">${edition.date}</td>
                          <td style="padding: 0.5em; text-align: right;">${edition.views}</td>
                          <td style="padding: 0.5em; text-align: right;">${Math.floor(edition.avg_time / 60)}m ${edition.avg_time % 60}s</td>
                          <td style="padding: 0.5em; text-align: right; color: ${edition.bounce_rate < 50 ? '#006400' : edition.bounce_rate < 70 ? '#8b4513' : '#8b0000'};">${edition.bounce_rate}%</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                ` : ''}
              </div>
              ` : ''}

              <!-- User Journey -->
              ${journeyRes?.entry_pages?.length > 0 || journeyRes?.exit_pages?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">User Journey</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Entry Pages (Where Users Land)</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                      <thead>
                        <tr style="border-bottom: 2px solid #000;">
                          <th style="padding: 0.5em; text-align: left; font-weight: 700;">Page</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">%</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${journeyRes.entry_pages.slice(0, 5).map(entry => `
                          <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 0.5em;">${escapeHtml(getPageName(entry.path))}</td>
                            <td style="padding: 0.5em; text-align: right;">${entry.percentage}%</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                  <div>
                    <h5 style="margin-top: 0; margin-bottom: 0.5em; font-size: 1em;">Exit Pages (Where Users Leave)</h5>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                      <thead>
                        <tr style="border-bottom: 2px solid #000;">
                          <th style="padding: 0.5em; text-align: left; font-weight: 700;">Page</th>
                          <th style="padding: 0.5em; text-align: right; font-weight: 700;">Exit Rate</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${journeyRes.exit_rates?.slice(0, 5).map(exit => `
                          <tr style="border-bottom: 1px solid #ccc;">
                            <td style="padding: 0.5em;">${escapeHtml(getPageName(exit.path))}</td>
                            <td style="padding: 0.5em; text-align: right; color: ${exit.exit_rate > 70 ? '#8b0000' : exit.exit_rate > 50 ? '#8b4513' : '#006400'};">${exit.exit_rate}%</td>
                          </tr>
                        `).join('') || '<tr><td colspan="2" style="padding: 0.5em; text-align: center; color: #666;">No exit data</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              ` : ''}

              <!-- Page Views by Hour (1) -->
              ${hourlyRes?.hourly?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
                  <h4 style="margin: 0;">Page Views by Hour of Day (CST)</h4>
                  <div id="hourly-filter-indicator" style="display: none; font-size: 0.9em; color: #666;">
                    <span id="filtered-page-name"></span>
                    <button onclick="clearHourlyFilter()" style="margin-left: 0.5em; padding: 0.25em 0.5em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.85em;">Clear Filter</button>
                  </div>
                </div>
                <canvas id="hourlyViewsChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              <!-- Time on Page by Page (2) -->
              ${timeonpageRes?.by_page?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Average Time on Page</h4>
                <canvas id="timeOnPageChart" style="max-height: 400px;"></canvas>
              </div>
              ` : ''}

              <!-- Device Types and Top Countries side by side (3 & 4) -->
              <!-- Device Types -->
              ${devicesRes?.devices?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Device Types</h4>
                <canvas id="deviceTypesChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              ${!pageviewsRes && !visitorsRes ? `
              <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <p style="font-size: 0.9em; color: #666;">
                  No analytics data available yet. Data will appear here once visitors start using the site.
                </p>
              </div>
              ` : ''}
            `;

            metricsEl.innerHTML = html;
            
            // Store data globally for filtering functionality
            window.currentAnalyticsData = {
              hourly: hourlyRes?.hourly || [],
              timeOnPage: timeonpageRes?.by_page || [],
              timeline: timelineRes || null,
              growth: growthRes || null,
              engagement: engagementRes || null,
              sources: sourcesRes || null,
              content: contentRes || null,
              journey: journeyRes || null,
              period: period,
              token: token
            };
            window.selectedPagePath = null; // Track selected page for filtering
            window.timelineState = {
              level: 'months', // 'months', 'days', 'hours'
              selectedMonth: null,
              selectedDay: null
            };
            // Store original timeline data for navigation
            window.originalTimelineData = timelineRes || null;
            
            // Render charts after HTML is inserted (in order)
            if (pageviewsRes?.daily?.length > 0) {
              renderTrafficTrendChart(pageviewsRes.daily);
            }
            if (timelineRes?.months?.length > 0) {
              // Initialize timeline with months view
              switchTimelineView('months');
            }
            if (timelineRes?.day_of_week?.length > 0) {
              renderDayOfWeekChart(timelineRes.day_of_week);
            }
            if (engagementRes?.time_distribution) {
              renderTimeDistributionChart(engagementRes.time_distribution);
            }
            if (engagementRes?.pages_per_session?.distribution) {
              renderPagesPerSessionChart(engagementRes.pages_per_session.distribution);
            }
            if (sourcesRes?.categories?.length > 0) {
              renderSourcesPieChart(sourcesRes.categories);
            }
            if (hourlyRes?.hourly?.length > 0) {
              renderHourlyViewsChart(hourlyRes.hourly);
            }
            if (timeonpageRes?.by_page?.length > 0) {
              renderTimeOnPageChart(timeonpageRes.by_page);
            }
            if (devicesRes?.devices?.length > 0) {
              renderDeviceTypesChart(devicesRes.devices);
            }
          } catch (err) {
            console.error("Error loading site metrics:", err);
            metricsEl.innerHTML = `
              <p><strong>Site Analytics</strong></p>
              <p style="color: darkred;">Error loading analytics information. Check console for details.</p>
              <p style="font-size: 0.85em; color: #666; margin-top: 0.5em;">
                Error: ${escapeHtml(err.message || 'Unknown error')}
              </p>
            `;
          }
        }

        // Render Device Types bar chart
        function renderDeviceTypesChart(data) {
          // Destroy existing chart if it exists
          if (window.deviceTypesChartInstance) {
            window.deviceTypesChartInstance.destroy();
          }

          const ctx = document.getElementById('deviceTypesChart');
          if (!ctx) return;

          // Reverse data for horizontal bar chart (top to bottom)
          const reversedData = [...data].reverse();
          const labels = reversedData.map(device => {
            const type = device.type || 'desktop';
            return type.charAt(0).toUpperCase() + type.slice(1);
          });
          const values = reversedData.map(device => device.count);

          window.deviceTypesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Views',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal bar chart
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 11,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Time on Page bar chart
        function renderTimeOnPageChart(data) {
          // Destroy existing chart if it exists
          if (window.timeOnPageChartInstance) {
            window.timeOnPageChartInstance.destroy();
          }

          const ctx = document.getElementById('timeOnPageChart');
          if (!ctx) return;

          // Data is already sorted from most to least (highest to lowest average)
          // Don't reverse so it displays most to least (top to bottom)
          const labels = data.map(page => getPageName(page.path || '/'));
          const values = data.map(page => Math.round(page.average));

          window.timeOnPageChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Average Time (seconds)',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal bar chart
              responsive: true,
              maintainAspectRatio: true,
              // Add click interaction
              onClick: function(event, elements) {
                if (elements.length > 0) {
                  // Get the clicked bar index
                  const clickedIndex = elements[0].index;
                  // Get the page path from the data
                  const selectedPage = data[clickedIndex];
                  if (selectedPage && selectedPage.path) {
                    // Filter hourly chart by this page
                    filterHourlyChartByPage(selectedPage.path, getPageName(selectedPage.path || '/'));
                  }
                }
              },
              // Change cursor to pointer to indicate clickability
              onHover: function(event, elements) {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
              },
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 10,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value + 's' : '';
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    callback: function(value) {
                      return value + 's';
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Hourly Views line chart
        function renderHourlyViewsChart(data) {
          // Destroy existing chart if it exists
          if (window.hourlyViewsChartInstance) {
            window.hourlyViewsChartInstance.destroy();
          }

          const ctx = document.getElementById('hourlyViewsChart');
          if (!ctx) return;

          // Format labels (0-23 hours)
          const labels = data.map(item => {
            const hour = item.hour;
            // Format as 12-hour time (e.g., "12 AM", "1 PM")
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour} ${period}`;
          });
          const values = data.map(item => item.count);

          window.hourlyViewsChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Page Views',
                data: values,
                borderColor: '#000',
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4, // Smooth curve
                pointBackgroundColor: '#000',
                pointBorderColor: '#f4e8d4',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(244, 232, 212, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#000',
                  borderColor: '#000',
                  borderWidth: 1,
                  padding: 12,
                  callbacks: {
                    label: function(context) {
                      return 'Views: ' + context.parsed.y;
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    maxRotation: 45,
                    minRotation: 45
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        }

        // Filter hourly chart by selected page
        async function filterHourlyChartByPage(pagePath, pageName) {
          // Store the selected page path
          window.selectedPagePath = pagePath;
          
          // Show filter indicator
          const indicator = document.getElementById('hourly-filter-indicator');
          const pageNameSpan = document.getElementById('filtered-page-name');
          if (indicator && pageNameSpan) {
            pageNameSpan.textContent = `Filtered by: ${pageName}`;
            indicator.style.display = 'block';
          }

          // Get current analytics data
          const analyticsData = window.currentAnalyticsData;
          if (!analyticsData || !analyticsData.token) {
            console.error('Analytics data not available');
            return;
          }

          try {
            // Fetch filtered hourly data
            const period = analyticsData.period || '7d';
            const response = await fetch(`/api/analytics-data?metric=hourly&period=${period}&page_path=${encodeURIComponent(pagePath)}`, {
              headers: { 'Authorization': `Bearer ${analyticsData.token}` }
            });

            if (response.ok) {
              const filteredData = await response.json();
              if (filteredData?.hourly?.length > 0) {
                // Re-render the hourly chart with filtered data
                renderHourlyViewsChart(filteredData.hourly);
              } else {
                // No data for this page - show empty chart
                renderHourlyViewsChart(Array.from({length: 24}, (_, i) => ({ hour: i, count: 0 })));
              }
            } else {
              console.error('Failed to fetch filtered hourly data');
            }
          } catch (error) {
            console.error('Error filtering hourly chart:', error);
          }
        }

        // Clear the hourly filter and show all data
        function clearHourlyFilter() {
          window.selectedPagePath = null;
          
          // Hide filter indicator
          const indicator = document.getElementById('hourly-filter-indicator');
          if (indicator) {
            indicator.style.display = 'none';
          }

          // Get original hourly data and re-render
          const analyticsData = window.currentAnalyticsData;
          if (analyticsData && analyticsData.hourly && analyticsData.hourly.length > 0) {
            renderHourlyViewsChart(analyticsData.hourly);
          }
        }

        // Render Timeline Chart (Month -> Day -> Hour drill-down)
        // Switch timeline view (months/days/hours)
        async function switchTimelineView(viewType) {
          const analyticsData = window.currentAnalyticsData;
          if (!analyticsData || !analyticsData.token) {
            console.error('Analytics data not available');
            return;
          }

          // Update button styles
          document.getElementById('timeline-btn-months').style.backgroundColor = viewType === 'months' ? '#000' : '#8b4513';
          document.getElementById('timeline-btn-days').style.backgroundColor = viewType === 'days' ? '#000' : '#8b4513';
          document.getElementById('timeline-btn-hours').style.backgroundColor = viewType === 'hours' ? '#000' : '#8b4513';

          try {
            const period = analyticsData.period || '7d';
            let url = `/api/analytics-data?metric=timeline&period=${period}`;
            
            // For days and hours, we need to fetch aggregated data
            // The API will return all days/hours when no month/day filter is provided
            
            const response = await fetch(url, {
              headers: { 'Authorization': `Bearer ${analyticsData.token}` }
            });

            if (response.ok) {
              const data = await response.json();
              
              // For days view, aggregate all days from all months
              if (viewType === 'days' && data.months && data.months.length > 0) {
                // Fetch days for each month and aggregate
                const allDays = {};
                for (const month of data.months) {
                  const dayResponse = await fetch(`${url}&month=${month.month}`, {
                    headers: { 'Authorization': `Bearer ${analyticsData.token}` }
                  });
                  if (dayResponse.ok) {
                    const dayData = await dayResponse.json();
                    if (dayData.days) {
                      dayData.days.forEach(d => {
                        allDays[d.day] = (allDays[d.day] || 0) + d.count;
                      });
                    }
                  }
                }
                // Convert to array format
                const sortedDays = Object.entries(allDays)
                  .map(([day, count]) => ({
                    day: day,
                    count: count,
                    label: new Date(day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                  }))
                  .sort((a, b) => a.day.localeCompare(b.day));
                data.days = sortedDays;
              }
              
              // For hours view, aggregate all hours from all days
              if (viewType === 'hours' && data.months && data.months.length > 0) {
                const allHours = {};
                for (let i = 0; i < 24; i++) {
                  allHours[i] = 0;
                }
                // Fetch hours for each month's days
                for (const month of data.months) {
                  const dayResponse = await fetch(`${url}&month=${month.month}`, {
                    headers: { 'Authorization': `Bearer ${analyticsData.token}` }
                  });
                  if (dayResponse.ok) {
                    const dayData = await dayResponse.json();
                    if (dayData.days) {
                      for (const day of dayData.days) {
                        const hourResponse = await fetch(`${url}&month=${month.month}&day=${day.day}`, {
                          headers: { 'Authorization': `Bearer ${analyticsData.token}` }
                        });
                        if (hourResponse.ok) {
                          const hourData = await hourResponse.json();
                          if (hourData.hours) {
                            hourData.hours.forEach(h => {
                              allHours[h.hour] = (allHours[h.hour] || 0) + h.count;
                            });
                          }
                        }
                      }
                    }
                  }
                }
                data.hours = Object.entries(allHours).map(([hour, count]) => ({
                  hour: parseInt(hour),
                  count: count
                }));
              }
              
              renderTimelineChart(data, viewType);
            } else {
              console.error('Failed to fetch timeline data');
            }
          } catch (error) {
            console.error('Error switching timeline view:', error);
          }
        }

        function renderTimelineChart(data, level) {
          // Destroy existing chart if it exists
          if (window.timelineChartInstance) {
            window.timelineChartInstance.destroy();
          }

          const ctx = document.getElementById('timelineChart');
          if (!ctx) return;

          let labels = [];
          let values = [];

          if (level === 'months') {
            if (!data.months || data.months.length === 0) {
              labels = ['No data'];
              values = [0];
            } else {
              labels = data.months.map(m => m.label);
              values = data.months.map(m => m.count);
            }
          } else if (level === 'days') {
            if (!data.days || data.days.length === 0) {
              labels = ['No data'];
              values = [0];
            } else {
              labels = data.days.map(d => d.label || new Date(d.day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
              values = data.days.map(d => d.count);
            }
          } else if (level === 'hours') {
            // Aggregate all hours across all days
            const hourCounts = {};
            for (let i = 0; i < 24; i++) {
              hourCounts[i] = 0;
            }
            if (data.hours && data.hours.length > 0) {
              data.hours.forEach(h => {
                hourCounts[h.hour] = (hourCounts[h.hour] || 0) + h.count;
              });
            }
            for (let i = 0; i < 24; i++) {
              const period = i >= 12 ? 'PM' : 'AM';
              const displayHour = i === 0 ? 12 : i > 12 ? i - 12 : i;
              labels.push(`${displayHour} ${period}`);
              values.push(hourCounts[i] || 0);
            }
          }

          const chartConfig = {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Visits',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'x', // Vertical bars
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false // Disable hover tooltips
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 11,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    maxRotation: level === 'hours' ? 0 : 45,
                    minRotation: level === 'hours' ? 0 : 45
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            },
            plugins: [ChartDataLabels] // Add data labels plugin
          };

          window.timelineChartInstance = new Chart(ctx, chartConfig);
        }

        // Old drill-down functions removed - replaced by switchTimelineView button selector

        // Render Traffic Trend Chart (Daily with comparison)
        function renderTrafficTrendChart(dailyData) {
          if (window.trafficTrendChartInstance) {
            window.trafficTrendChartInstance.destroy();
          }

          const ctx = document.getElementById('trafficTrendChart');
          if (!ctx) return;

          // Format dates for labels
          const labels = dailyData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          });
          const values = dailyData.map(item => item.count);

          window.trafficTrendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Page Views',
                data: values,
                borderColor: '#000',
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#000',
                pointBorderColor: '#f4e8d4',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 10,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    maxRotation: 45,
                    minRotation: 45
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        }

        // Render Day of Week Chart
        function renderDayOfWeekChart(dayData) {
          if (window.dayOfWeekChartInstance) {
            window.dayOfWeekChartInstance.destroy();
          }

          const ctx = document.getElementById('dayOfWeekChart');
          if (!ctx) return;

          const labels = dayData.map(d => d.day);
          const values = dayData.map(d => d.count);

          window.dayOfWeekChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Visits',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 11,
                    weight: 'bold'
                  },
                  formatter: function(value) {
                    return value > 0 ? value : '';
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        }

        // Render Time Distribution Chart
        function renderTimeDistributionChart(distribution) {
          if (window.timeDistributionChartInstance) {
            window.timeDistributionChartInstance.destroy();
          }

          const ctx = document.getElementById('timeDistributionChart');
          if (!ctx) return;

          const labels = Object.keys(distribution);
          const values = Object.values(distribution);
          const total = values.reduce((a, b) => a + b, 0);
          const percentages = values.map(v => total > 0 ? Math.round((v / total) * 100) : 0);

          window.timeDistributionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Visitors',
                data: percentages,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 10,
                    weight: 'bold'
                  },
                  formatter: function(value, context) {
                    const index = context.dataIndex;
                    return `${percentages[index]}%`;
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    callback: function(value) {
                      return value + '%';
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Pages per Session Chart
        function renderPagesPerSessionChart(distribution) {
          if (window.pagesPerSessionChartInstance) {
            window.pagesPerSessionChartInstance.destroy();
          }

          const ctx = document.getElementById('pagesPerSessionChart');
          if (!ctx) return;

          const labels = Object.keys(distribution);
          const values = Object.values(distribution);
          const total = values.reduce((a, b) => a + b, 0);
          const percentages = values.map(v => total > 0 ? Math.round((v / total) * 100) : 0);

          window.pagesPerSessionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels.map(l => l === '1' ? '1 page' : l === '2-3' ? '2-3 pages' : l === '4-5' ? '4-5 pages' : '6+ pages'),
              datasets: [{
                label: 'Sessions',
                data: percentages,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  anchor: 'end',
                  align: 'right',
                  color: '#000',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 10,
                    weight: 'bold'
                  },
                  formatter: function(value, context) {
                    const index = context.dataIndex;
                    return `${percentages[index]}%`;
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    callback: function(value) {
                      return value + '%';
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Traffic Sources Pie Chart
        function renderSourcesPieChart(categories) {
          if (window.sourcesPieChartInstance) {
            window.sourcesPieChartInstance.destroy();
          }

          const ctx = document.getElementById('sourcesPieChart');
          if (!ctx) return;

          const labels = categories.map(c => c.name);
          const values = categories.map(c => c.count);
          const colors = ['#000', '#333', '#666', '#999'];

          window.sourcesPieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: values,
                backgroundColor: [
                  'rgba(0, 0, 0, 0.8)',
                  'rgba(0, 0, 0, 0.6)',
                  'rgba(0, 0, 0, 0.4)',
                  'rgba(0, 0, 0, 0.2)'
                ],
                borderColor: '#000',
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    padding: 15
                  }
                },
                tooltip: {
                  enabled: false
                },
                datalabels: {
                  color: '#fff',
                  font: {
                    family: "'EB Garamond', serif",
                    size: 12,
                    weight: 'bold'
                  },
                  formatter: function(value, context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                    return percentage > 5 ? `${percentage}%` : ''; // Only show if > 5%
                  }
                }
              }
            }
          });
        }

        // Reset all analytics data
        async function resetAnalyticsData() {
          if (!confirm('Are you sure you want to delete ALL analytics data? This cannot be undone.')) {
            return;
          }

          if (!confirm('This will permanently delete all page views, visitor sessions, and rate limit data. Continue?')) {
            return;
          }

          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              alert('Please sign in to reset data.');
              return;
            }

            const token = session.access_token;
            const response = await fetch('/api/reset-analytics', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });

            if (response.ok) {
              const result = await response.json();
              alert('All analytics data has been reset successfully. The dashboard will refresh.');
              // Reload metrics
              loadSiteMetrics();
            } else {
              const error = await response.json();
              alert('Error resetting data: ' + (error.error || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error resetting analytics:', error);
            alert('Error resetting data. Check console for details.');
          }
        }
      </script>
    </div>
    <!-- Page footer -->
    <div style="max-width: 800px; margin: 0 auto; padding: 0 20px">
      <img src="images/divider.png" alt="divider" class="divider" />
      <nav style="text-align: center; margin: 1em 0">
        <ul>
          <li>
            <a href="index.html">
              <span class="nav-initial">H</span
              ><span class="nav-word">ome</span>
            </a>
          </li>
          <li>
            <a href="about.html">
              <span class="nav-initial">A</span
              ><span class="nav-word">bout</span>
            </a>
          </li>
          <li>
            <a href="submit.html">
              <span class="nav-initial">S</span
              ><span class="nav-word">ubmit</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="page-footer">
        <p style="text-align: center; margin-bottom: 0.5em">
          &copy; 2026 The Watchman's Cry: Common Sense Reborn
        </p>
        RSJr. For the Republic.
      </div>
    </div>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchman Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <!-- Chart.js for bar charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>The Watchman's Cry – Admin Only</h1>
        <img src="images/divider.png" alt="divider" class="divider" />
      </header>

      <div id="login" style="text-align: center; margin: 4em 0">
        <h3>Admin Access</h3>
        <div id="login-form" style="max-width: 400px; margin: 0 auto">
          <input
            type="email"
            id="admin-email"
            placeholder="Email"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <input
            type="password"
            id="admin-password"
            placeholder="Password"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <button
            onclick="signIn()"
            style="
              padding: 0.75em 2em;
              background-color: #000;
              color: #f4e8d4;
              border: none;
              font-family: 'EB Garamond', serif;
              font-size: 1em;
              font-weight: 700;
              cursor: pointer;
              width: 100%;
            "
          >
            Sign In
          </button>
          <p
            id="login-error"
            style="color: darkred; margin-top: 1em; display: none"
          ></p>
        </div>
        <!-- Signup disabled for security - accounts must be created through Supabase dashboard -->
        <p
          id="signup-info"
          style="font-size: 0.9em; color: #666; margin-top: 1em; display: none"
        >
          Admin accounts must be created through the Supabase dashboard for
          security.
        </p>
      </div>

      <div id="admin-content" style="display: none">
        <h2>Submissions</h2>

        <h3>Counsel Questions</h3>
        <div id="counsel-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Site Metrics</h3>
        <div id="site-metrics" style="margin-bottom: 2em">
          <p>Loading site metrics...</p>
        </div>
      </div>

      <script>
        // Security: HTML escaping function to prevent XSS attacks
        function escapeHtml(text) {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        // Convert page path to common name
        function getPageName(path) {
          const pageNames = {
            '/': 'Home',
            '/index.html': 'Home',
            '/about.html': 'About',
            '/submit.html': 'Submit',
            '/staff.html': 'Voices',
            '/archive.html': 'Archive',
            '/privacy-policy.html': 'Privacy Policy',
            '/test-analytics.html': 'Test Analytics',
            '/admin.html': 'Admin',
            '/prelaunch.html': 'Prelaunch'
          };
          
          // Check exact match first
          if (pageNames[path]) {
            return pageNames[path];
          }
          
          // Check if it's an archive edition
          if (path.startsWith('/archive/')) {
            const match = path.match(/edition-(\d{4}-\d{2}-\d{2})/);
            if (match) {
              return `Edition ${match[1]}`;
            }
            return 'Archive Edition';
          }
          
          // Fallback: return path without leading slash
          return path.replace(/^\//, '') || 'Home';
        }

        // Check if user is already signed in on page load
        window.addEventListener("DOMContentLoaded", async () => {
          const {
            data: { session },
          } = await supabaseClient.auth.getSession();
          if (session) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            loadSubmissions();
          }
        });

        // Signup function removed for security - accounts must be created via Supabase dashboard

        async function signIn() {
          const email = document.getElementById("admin-email").value;
          const password = document.getElementById("admin-password").value;
          const errorEl = document.getElementById("login-error");

          if (!email || !password) {
            errorEl.textContent = "Please enter both email and password.";
            errorEl.style.display = "block";
            return;
          }

          errorEl.style.display = "none";

          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            // Security: Don't expose detailed error messages that could help attackers
            errorEl.textContent =
              "Invalid email or password. Please try again.";
            errorEl.style.display = "block";
            return;
          }

          // Success - hide login, show admin content
          document.getElementById("login").style.display = "none";
          document.getElementById("admin-content").style.display = "block";
          loadSubmissions();
        }

        // Signup function removed for security - prevent unauthorized account creation

        async function loadSubmissions() {
          // Load counsel questions data
          const counselEl = document.getElementById("counsel-data");
          counselEl.innerHTML = "<p>Loading counsel questions...</p>";

          try {
            console.log(
              "Attempting to load counsel questions from Supabase..."
            );
            const { data: counsel, error: counselError } = await supabaseClient
              .from("counsel_questions")
              .select("*")
              .order("created_at", { ascending: false });

            console.log("Supabase response:", {
              data: counsel,
              error: counselError,
            });

            if (counselError) {
              console.error("Supabase error:", counselError);
              counselEl.innerHTML = `
                <p style="color: darkred;"><strong>Error:</strong> ${escapeHtml(
                  counselError.message
                )}</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                  <strong>Note:</strong> This is likely a Row Level Security (RLS) policy issue. 
                  To fix this, you need to:
                  <ol style="margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Go to your Supabase dashboard</li>
                    <li>Navigate to Authentication → Policies for the "counsel_questions" table</li>
                    <li>Create a policy that allows SELECT operations (or temporarily disable RLS for testing)</li>
                    <li>Alternatively, use a service_role key server-side (never expose this in client code)</li>
                  </ol>
                  <p style="margin-top: 0.5em;">
                    <strong>Debug info:</strong> Check browser console (F12) for detailed error information.
                  </p>
                </p>
              `;
            } else if (!counsel || counsel.length === 0) {
              counselEl.innerHTML = "<p>No counsel questions yet.</p>";
            } else {
              console.log(`Loaded ${counsel.length} counsel questions`);
              let html = `<p><strong>Total: ${counsel.length} questions</strong></p>`;
              html += `<table style="width: 100%; border-collapse: collapse; margin-top: 1em; border: 1px solid #000;">`;
              html += `<thead>`;
              html += `<tr style="background-color: rgba(244, 232, 212, 0.5); border-bottom: 2px solid #000;">`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Date</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Name</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Profession</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">State</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Question</th>`;
              html += `</tr>`;
              html += `</thead>`;
              html += `<tbody>`;
              counsel.forEach((entry) => {
                const date = entry.created_at
                  ? new Date(entry.created_at).toLocaleDateString()
                  : "Date unknown";
                html += `<tr style="border-bottom: 1px solid #000;">`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  date
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.name || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.profession || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.state || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.question || "No question text"
                )}</td>`;
                html += `</tr>`;
              });
              html += `</tbody>`;
              html += `</table>`;
              counselEl.innerHTML = html;
            }
          } catch (err) {
            console.error("Exception loading counsel questions:", err);
            counselEl.innerHTML = `
              <p style="color: darkred;"><strong>Error loading counsel questions:</strong> ${escapeHtml(
                err.message
              )}</p>
              <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                Check browser console (F12) for more details.
              </p>
            `;
          }

          // Load Site Metrics (Supabase Analytics)
          loadSiteMetrics();
        }

        async function loadSiteMetrics() {
          const metricsEl = document.getElementById("site-metrics");
          metricsEl.innerHTML = "<p>Loading site metrics...</p>";

          try {
            // Get current session token
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
              metricsEl.innerHTML = `
                <p><strong>Site Analytics</strong></p>
                <p style="color: darkred;">Please sign in to view analytics.</p>
              `;
              return;
            }

            // Get selected period from dropdown or default to 7d
            const periodSelect = document.getElementById('analytics-period');
            const period = periodSelect ? periodSelect.value : '7d';
            const token = session.access_token;

            const [pageviewsRes, visitorsRes, devicesRes, geographyRes, timeonpageRes, hourlyRes] = await Promise.all([
              fetch(`/api/analytics-data?metric=pageviews&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=visitors&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=devices&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=geography&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=timeonpage&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null),
              fetch(`/api/analytics-data?metric=hourly&period=${period}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              }).then(r => r.ok ? r.json() : null).catch(() => null)
            ]);

            let html = `
              <p><strong>Site Analytics</strong></p>
              <div style="margin-bottom: 1em;">
                <label style="font-weight: 700; margin-right: 0.5em;">Time Period:</label>
                <select id="analytics-period" onchange="loadSiteMetrics()" style="padding: 0.25em; border: 1px solid #000; font-family: 'EB Garamond', serif;">
                  <option value="7d" ${period === '7d' ? 'selected' : ''}>Last 7 days</option>
                  <option value="30d" ${period === '30d' ? 'selected' : ''}>Last 30 days</option>
                  <option value="all" ${period === 'all' ? 'selected' : ''}>All time</option>
                </select>
                <button onclick="loadSiteMetrics()" style="margin-left: 0.5em; padding: 0.25em 0.75em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer;">Refresh</button>
              </div>
              
              <!-- Overview Cards -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em; margin-bottom: 2em;">
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Total Page Views</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0;">${pageviewsRes?.total || 0}</p>
                </div>
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Unique Visitors</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0;">${visitorsRes?.unique_visitors || 0}</p>
                </div>
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">New Visitors</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0;">${visitorsRes?.new_visitors || 0}</p>
                </div>
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000; text-align: center;">
                  <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Avg. Time on Page</p>
                  <p style="font-size: 2em; font-weight: 700; margin: 0;">${timeonpageRes?.overall_average || 0}s</p>
                </div>
              </div>

              <!-- Page Views by Hour (1) -->
              ${hourlyRes?.hourly?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
                  <h4 style="margin: 0;">Page Views by Hour of Day (CST)</h4>
                  <div id="hourly-filter-indicator" style="display: none; font-size: 0.9em; color: #666;">
                    <span id="filtered-page-name"></span>
                    <button onclick="clearHourlyFilter()" style="margin-left: 0.5em; padding: 0.25em 0.5em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; cursor: pointer; font-size: 0.85em;">Clear Filter</button>
                  </div>
                </div>
                <canvas id="hourlyViewsChart" style="max-height: 300px;"></canvas>
              </div>
              ` : ''}

              <!-- Time on Page by Page (2) -->
              ${timeonpageRes?.by_page?.length > 0 ? `
              <div style="margin-bottom: 2em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <h4 style="margin-top: 0; margin-bottom: 1em;">Average Time on Page</h4>
                <canvas id="timeOnPageChart" style="max-height: 400px;"></canvas>
              </div>
              ` : ''}

              <!-- Device Types and Top Countries side by side (3 & 4) -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 2em;">
                ${devicesRes?.devices?.length > 0 ? `
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                  <h4 style="margin-top: 0; margin-bottom: 1em;">Device Types</h4>
                  <canvas id="deviceTypesChart" style="max-height: 300px;"></canvas>
                </div>
                ` : '<div></div>'}
                ${geographyRes?.countries?.length > 0 ? `
                <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                  <h4 style="margin-top: 0; margin-bottom: 1em;">Top Countries</h4>
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 2px solid #000;">
                        <th style="padding: 0.5em; text-align: left; font-weight: 700;">Country</th>
                        <th style="padding: 0.5em; text-align: right; font-weight: 700;">Views</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${geographyRes.countries.map(country => `
                        <tr style="border-bottom: 1px solid #ccc;">
                          <td style="padding: 0.5em;">${escapeHtml(country.country)}</td>
                          <td style="padding: 0.5em; text-align: right;">${country.count}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                ` : '<div></div>'}
              </div>

              ${!pageviewsRes && !visitorsRes ? `
              <div style="padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <p style="font-size: 0.9em; color: #666;">
                  No analytics data available yet. Data will appear here once visitors start using the site.
                </p>
              </div>
              ` : ''}
            `;

            metricsEl.innerHTML = html;
            
            // Store data globally for filtering functionality
            window.currentAnalyticsData = {
              hourly: hourlyRes?.hourly || [],
              timeOnPage: timeonpageRes?.by_page || [],
              period: period,
              token: token
            };
            window.selectedPagePath = null; // Track selected page for filtering
            
            // Render charts after HTML is inserted (in order)
            if (hourlyRes?.hourly?.length > 0) {
              renderHourlyViewsChart(hourlyRes.hourly);
            }
            if (timeonpageRes?.by_page?.length > 0) {
              renderTimeOnPageChart(timeonpageRes.by_page);
            }
            if (devicesRes?.devices?.length > 0) {
              renderDeviceTypesChart(devicesRes.devices);
            }
          } catch (err) {
            console.error("Error loading site metrics:", err);
            metricsEl.innerHTML = `
              <p><strong>Site Analytics</strong></p>
              <p style="color: darkred;">Error loading analytics information. Check console for details.</p>
              <p style="font-size: 0.85em; color: #666; margin-top: 0.5em;">
                Error: ${escapeHtml(err.message || 'Unknown error')}
              </p>
            `;
          }
        }

        // Render Device Types bar chart
        function renderDeviceTypesChart(data) {
          // Destroy existing chart if it exists
          if (window.deviceTypesChartInstance) {
            window.deviceTypesChartInstance.destroy();
          }

          const ctx = document.getElementById('deviceTypesChart');
          if (!ctx) return;

          // Reverse data for horizontal bar chart (top to bottom)
          const reversedData = [...data].reverse();
          const labels = reversedData.map(device => {
            const type = device.type || 'desktop';
            return type.charAt(0).toUpperCase() + type.slice(1);
          });
          const values = reversedData.map(device => device.count);

          window.deviceTypesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Views',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal bar chart
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(244, 232, 212, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#000',
                  borderColor: '#000',
                  borderWidth: 1,
                  padding: 12,
                  callbacks: {
                    label: function(context) {
                      return 'Views: ' + context.parsed.x;
                    }
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Time on Page bar chart
        function renderTimeOnPageChart(data) {
          // Destroy existing chart if it exists
          if (window.timeOnPageChartInstance) {
            window.timeOnPageChartInstance.destroy();
          }

          const ctx = document.getElementById('timeOnPageChart');
          if (!ctx) return;

          // Data is already sorted from most to least (highest to lowest average)
          // Don't reverse so it displays most to least (top to bottom)
          const labels = data.map(page => getPageName(page.path || '/'));
          const values = data.map(page => Math.round(page.average));

          window.timeOnPageChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Average Time (seconds)',
                data: values,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                borderColor: '#000',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y', // Horizontal bar chart
              responsive: true,
              maintainAspectRatio: true,
              // Add click interaction
              onClick: function(event, elements) {
                if (elements.length > 0) {
                  // Get the clicked bar index
                  const clickedIndex = elements[0].index;
                  // Get the page path from the data
                  const selectedPage = data[clickedIndex];
                  if (selectedPage && selectedPage.path) {
                    // Filter hourly chart by this page
                    filterHourlyChartByPage(selectedPage.path, getPageName(selectedPage.path || '/'));
                  }
                }
              },
              // Change cursor to pointer to indicate clickability
              onHover: function(event, elements) {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
              },
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(244, 232, 212, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#000',
                  borderColor: '#000',
                  borderWidth: 1,
                  padding: 12,
                  callbacks: {
                    label: function(context) {
                      return 'Avg. Time: ' + context.parsed.x + 's';
                    },
                    afterTitle: function(context) {
                      return 'Click to filter hourly chart';
                    }
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    callback: function(value) {
                      return value + 's';
                    }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    }
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }

        // Render Hourly Views line chart
        function renderHourlyViewsChart(data) {
          // Destroy existing chart if it exists
          if (window.hourlyViewsChartInstance) {
            window.hourlyViewsChartInstance.destroy();
          }

          const ctx = document.getElementById('hourlyViewsChart');
          if (!ctx) return;

          // Format labels (0-23 hours)
          const labels = data.map(item => {
            const hour = item.hour;
            // Format as 12-hour time (e.g., "12 AM", "1 PM")
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour} ${period}`;
          });
          const values = data.map(item => item.count);

          window.hourlyViewsChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Page Views',
                data: values,
                borderColor: '#000',
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4, // Smooth curve
                pointBackgroundColor: '#000',
                pointBorderColor: '#f4e8d4',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(244, 232, 212, 0.95)',
                  titleColor: '#000',
                  bodyColor: '#000',
                  borderColor: '#000',
                  borderWidth: 1,
                  padding: 12,
                  callbacks: {
                    label: function(context) {
                      return 'Views: ' + context.parsed.y;
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 11
                    },
                    maxRotation: 45,
                    minRotation: 45
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: '#000',
                    font: {
                      family: "'EB Garamond', serif",
                      size: 12
                    },
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            }
          });
        }

        // Filter hourly chart by selected page
        async function filterHourlyChartByPage(pagePath, pageName) {
          // Store the selected page path
          window.selectedPagePath = pagePath;
          
          // Show filter indicator
          const indicator = document.getElementById('hourly-filter-indicator');
          const pageNameSpan = document.getElementById('filtered-page-name');
          if (indicator && pageNameSpan) {
            pageNameSpan.textContent = `Filtered by: ${pageName}`;
            indicator.style.display = 'block';
          }

          // Get current analytics data
          const analyticsData = window.currentAnalyticsData;
          if (!analyticsData || !analyticsData.token) {
            console.error('Analytics data not available');
            return;
          }

          try {
            // Fetch filtered hourly data
            const period = analyticsData.period || '7d';
            const response = await fetch(`/api/analytics-data?metric=hourly&period=${period}&page_path=${encodeURIComponent(pagePath)}`, {
              headers: { 'Authorization': `Bearer ${analyticsData.token}` }
            });

            if (response.ok) {
              const filteredData = await response.json();
              if (filteredData?.hourly?.length > 0) {
                // Re-render the hourly chart with filtered data
                renderHourlyViewsChart(filteredData.hourly);
              } else {
                // No data for this page - show empty chart
                renderHourlyViewsChart(Array.from({length: 24}, (_, i) => ({ hour: i, count: 0 })));
              }
            } else {
              console.error('Failed to fetch filtered hourly data');
            }
          } catch (error) {
            console.error('Error filtering hourly chart:', error);
          }
        }

        // Clear the hourly filter and show all data
        function clearHourlyFilter() {
          window.selectedPagePath = null;
          
          // Hide filter indicator
          const indicator = document.getElementById('hourly-filter-indicator');
          if (indicator) {
            indicator.style.display = 'none';
          }

          // Get original hourly data and re-render
          const analyticsData = window.currentAnalyticsData;
          if (analyticsData && analyticsData.hourly && analyticsData.hourly.length > 0) {
            renderHourlyViewsChart(analyticsData.hourly);
          }
        }
      </script>
    </div>
    <!-- Page footer -->
    <div style="max-width: 800px; margin: 0 auto; padding: 0 20px">
      <img src="images/divider.png" alt="divider" class="divider" />
      <nav style="text-align: center; margin: 1em 0">
        <ul>
          <li>
            <a href="index.html">
              <span class="nav-initial">H</span
              ><span class="nav-word">ome</span>
            </a>
          </li>
          <li>
            <a href="about.html">
              <span class="nav-initial">A</span
              ><span class="nav-word">bout</span>
            </a>
          </li>
          <li>
            <a href="submit.html">
              <span class="nav-initial">S</span
              ><span class="nav-word">ubmit</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="page-footer">
        <p style="text-align: center; margin-bottom: 0.5em">
          &copy; 2026 The Watchman's Cry: Common Sense Reborn
        </p>
        RSJr. For the Republic.
      </div>
    </div>
  </body>
</html>

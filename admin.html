<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchman Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>The Watchman's Cry â€“ Admin Only</h1>
        <img src="images/divider.png" alt="divider" class="divider" />
      </header>

      <div id="login" style="text-align: center; margin: 4em 0">
        <h3>Admin Access</h3>
        <input type="password" id="admin-pass" placeholder="Enter passphrase" />
        <button onclick="checkAdmin()">Enter</button>
      </div>

      <div id="admin-content" style="display: none">
        <h2>Submissions</h2>
        <h3>Waitlist Emails</h3>
        <div id="waitlist-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Counsel Questions</h3>
        <div id="counsel-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Site Metrics</h3>
        <div id="vercel-metrics" style="margin-bottom: 2em">
          <p>Loading Vercel Analytics...</p>
        </div>
      </div>

      <script>
        const REAL_PASSWORD = "jasonboyer"; // CHANGE THIS!

        function checkAdmin() {
          const pass = document.getElementById("admin-pass").value;
          if (pass === REAL_PASSWORD) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            loadSubmissions();
          } else {
            alert("Access denied.");
          }
        }

        async function loadSubmissions() {
          // Load waitlist data
          try {
            const { data: waitlist, error: waitlistError } =
              await supabaseClient
                .from("waitlist")
                .select("*")
                .order("created_at", { ascending: false });

            const waitlistEl = document.getElementById("waitlist-data");
            if (waitlistError) {
              waitlistEl.innerHTML = `<p style="color: darkred;">Error: ${waitlistError.message}</p><p style="font-size: 0.9em; color: #666;">Note: You may need to configure Row Level Security (RLS) policies in Supabase to allow reads, or use a service_role key server-side.</p>`;
            } else if (!waitlist || waitlist.length === 0) {
              waitlistEl.innerHTML = "<p>No waitlist entries yet.</p>";
            } else {
              let html = `<p><strong>Total: ${waitlist.length} entries</strong></p><table style="width: 100%; border-collapse: collapse; margin-top: 1em;"><thead><tr style="border-bottom: 2px solid #000;"><th style="text-align: left; padding: 0.5em;">Email</th><th style="text-align: left; padding: 0.5em;">Date</th></tr></thead><tbody>`;
              waitlist.forEach((entry) => {
                const date = new Date(entry.created_at).toLocaleDateString();
                html += `<tr style="border-bottom: 1px solid #ccc;"><td style="padding: 0.5em;">${entry.email}</td><td style="padding: 0.5em;">${date}</td></tr>`;
              });
              html += "</tbody></table>";
              waitlistEl.innerHTML = html;
            }
          } catch (err) {
            document.getElementById(
              "waitlist-data"
            ).innerHTML = `<p style="color: darkred;">Error loading waitlist: ${err.message}</p>`;
          }

          // Load counsel questions data
          try {
            const { data: counsel, error: counselError } = await supabaseClient
              .from("counsel_questions")
              .select("*")
              .order("created_at", { ascending: false });

            const counselEl = document.getElementById("counsel-data");
            if (counselError) {
              counselEl.innerHTML = `<p style="color: darkred;">Error: ${counselError.message}</p><p style="font-size: 0.9em; color: #666;">Note: You may need to configure Row Level Security (RLS) policies in Supabase to allow reads.</p>`;
            } else if (!counsel || counsel.length === 0) {
              counselEl.innerHTML = "<p>No counsel questions yet.</p>";
            } else {
              let html = `<p><strong>Total: ${counsel.length} questions</strong></p>`;
              counsel.forEach((entry, index) => {
                const date = new Date(entry.created_at).toLocaleDateString();
                html += `<div style="border: 1px solid #000; padding: 1em; margin: 1em 0;">`;
                html += `<p><strong>Question ${
                  index + 1
                }</strong> - ${date}</p>`;
                if (entry.name)
                  html += `<p><strong>Name:</strong> ${entry.name}</p>`;
                if (entry.profession)
                  html += `<p><strong>Profession:</strong> ${entry.profession}</p>`;
                if (entry.state)
                  html += `<p><strong>State:</strong> ${entry.state}</p>`;
                html += `<p><strong>Question:</strong> ${entry.question}</p>`;
                html += `</div>`;
              });
              counselEl.innerHTML = html;
            }
          } catch (err) {
            document.getElementById(
              "counsel-data"
            ).innerHTML = `<p style="color: darkred;">Error loading counsel questions: ${err.message}</p>`;
          }

          // Load Vercel Analytics (if available)
          loadVercelMetrics();
        }

        function loadVercelMetrics() {
          const metricsEl = document.getElementById("vercel-metrics");

          // Check if Vercel Analytics is available
          if (typeof window.va !== "undefined") {
            metricsEl.innerHTML = `
              <p>Vercel Analytics is active.</p>
              <p style="font-size: 0.9em; color: #666;">
                For detailed metrics, visit your <a href="https://vercel.com/dashboard" target="_blank">Vercel Dashboard</a>.
                Analytics data is collected automatically and viewable in the Vercel project dashboard.
              </p>
            `;
          } else {
            // Try to load Vercel Analytics script
            const script = document.createElement("script");
            script.src = "https://va.vercel-scripts.com/v1/script.debug.js";
            script.defer = true;
            script.onload = () => {
              metricsEl.innerHTML = `
                <p>Vercel Analytics script loaded.</p>
                <p style="font-size: 0.9em; color: #666;">
                  Analytics will begin tracking. View detailed metrics in your 
                  <a href="https://vercel.com/dashboard" target="_blank">Vercel Dashboard</a>.
                </p>
              `;
            };
            script.onerror = () => {
              metricsEl.innerHTML = `
                <p style="color: darkred;">Vercel Analytics not configured.</p>
                <p style="font-size: 0.9em; color: #666;">
                  To enable Vercel Analytics:
                  <ol style="margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Install @vercel/analytics in your project</li>
                    <li>Add the Analytics component to your pages</li>
                    <li>View metrics in your Vercel Dashboard</li>
                  </ol>
                  <p style="margin-top: 0.5em;">
                    <a href="https://vercel.com/docs/analytics" target="_blank">Vercel Analytics Documentation</a>
                  </p>
                </p>
              `;
            };
            document.head.appendChild(script);
          }
        }
      </script>
    </div>
  </body>
</html>

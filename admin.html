<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchman Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>The Watchman's Cry â€“ Admin Only</h1>
        <img src="images/divider.png" alt="divider" class="divider" />
      </header>

      <div id="login" style="text-align: center; margin: 4em 0">
        <h3>Admin Access</h3>
        <div id="login-form" style="max-width: 400px; margin: 0 auto">
          <input
            type="email"
            id="admin-email"
            placeholder="Email"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <input
            type="password"
            id="admin-password"
            placeholder="Password"
            style="
              width: 100%;
              padding: 0.5em;
              margin-bottom: 1em;
              border: 1px solid #000;
              font-family: 'EB Garamond', serif;
            "
          />
          <button
            onclick="signIn()"
            style="
              padding: 0.75em 2em;
              background-color: #000;
              color: #f4e8d4;
              border: none;
              font-family: 'EB Garamond', serif;
              font-size: 1em;
              font-weight: 700;
              cursor: pointer;
              width: 100%;
            "
          >
            Sign In
          </button>
          <p
            id="login-error"
            style="color: darkred; margin-top: 1em; display: none"
          ></p>
        </div>
        <!-- Signup disabled for security - accounts must be created through Supabase dashboard -->
        <p
          id="signup-info"
          style="font-size: 0.9em; color: #666; margin-top: 1em; display: none"
        >
          Admin accounts must be created through the Supabase dashboard for
          security.
        </p>
      </div>

      <div id="admin-content" style="display: none">
        <h2>Submissions</h2>

        <h3>Counsel Questions</h3>
        <div id="counsel-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Site Metrics</h3>
        <div id="vercel-metrics" style="margin-bottom: 2em">
          <p>Loading Vercel Analytics...</p>
        </div>
      </div>

      <script>
        // Security: HTML escaping function to prevent XSS attacks
        function escapeHtml(text) {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        // Check if user is already signed in on page load
        window.addEventListener("DOMContentLoaded", async () => {
          const {
            data: { session },
          } = await supabaseClient.auth.getSession();
          if (session) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            loadSubmissions();
          }
        });

        // Signup function removed for security - accounts must be created via Supabase dashboard

        async function signIn() {
          const email = document.getElementById("admin-email").value;
          const password = document.getElementById("admin-password").value;
          const errorEl = document.getElementById("login-error");

          if (!email || !password) {
            errorEl.textContent = "Please enter both email and password.";
            errorEl.style.display = "block";
            return;
          }

          errorEl.style.display = "none";

          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            // Security: Don't expose detailed error messages that could help attackers
            errorEl.textContent =
              "Invalid email or password. Please try again.";
            errorEl.style.display = "block";
            return;
          }

          // Success - hide login, show admin content
          document.getElementById("login").style.display = "none";
          document.getElementById("admin-content").style.display = "block";
          loadSubmissions();
        }

        // Signup function removed for security - prevent unauthorized account creation

        async function loadSubmissions() {
          // Load counsel questions data
          const counselEl = document.getElementById("counsel-data");
          counselEl.innerHTML = "<p>Loading counsel questions...</p>";

          try {
            console.log(
              "Attempting to load counsel questions from Supabase..."
            );
            const { data: counsel, error: counselError } = await supabaseClient
              .from("counsel_questions")
              .select("*")
              .order("created_at", { ascending: false });

            console.log("Supabase response:", {
              data: counsel,
              error: counselError,
            });

            if (counselError) {
              console.error("Supabase error:", counselError);
              counselEl.innerHTML = `
                <p style="color: darkred;"><strong>Error:</strong> ${escapeHtml(
                  counselError.message
                )}</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                  <strong>Note:</strong> This is likely a Row Level Security (RLS) policy issue. 
                  To fix this, you need to:
                  <ol style="margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Go to your Supabase dashboard</li>
                    <li>Navigate to Authentication â†’ Policies for the "counsel_questions" table</li>
                    <li>Create a policy that allows SELECT operations (or temporarily disable RLS for testing)</li>
                    <li>Alternatively, use a service_role key server-side (never expose this in client code)</li>
                  </ol>
                  <p style="margin-top: 0.5em;">
                    <strong>Debug info:</strong> Check browser console (F12) for detailed error information.
                  </p>
                </p>
              `;
            } else if (!counsel || counsel.length === 0) {
              counselEl.innerHTML = "<p>No counsel questions yet.</p>";
            } else {
              console.log(`Loaded ${counsel.length} counsel questions`);
              let html = `<p><strong>Total: ${counsel.length} questions</strong></p>`;
              html += `<table style="width: 100%; border-collapse: collapse; margin-top: 1em; border: 1px solid #000;">`;
              html += `<thead>`;
              html += `<tr style="background-color: rgba(244, 232, 212, 0.5); border-bottom: 2px solid #000;">`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Date</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Name</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Profession</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">State</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Question</th>`;
              html += `</tr>`;
              html += `</thead>`;
              html += `<tbody>`;
              counsel.forEach((entry) => {
                const date = entry.created_at
                  ? new Date(entry.created_at).toLocaleDateString()
                  : "Date unknown";
                html += `<tr style="border-bottom: 1px solid #000;">`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  date
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.name || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.profession || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.state || "-"
                )}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${escapeHtml(
                  entry.question || "No question text"
                )}</td>`;
                html += `</tr>`;
              });
              html += `</tbody>`;
              html += `</table>`;
              counselEl.innerHTML = html;
            }
          } catch (err) {
            console.error("Exception loading counsel questions:", err);
            counselEl.innerHTML = `
              <p style="color: darkred;"><strong>Error loading counsel questions:</strong> ${escapeHtml(
                err.message
              )}</p>
              <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                Check browser console (F12) for more details.
              </p>
            `;
          }

          // Load Vercel Analytics
          loadVercelMetrics();
        }

        async function loadVercelMetrics() {
          const metricsEl = document.getElementById("vercel-metrics");
          metricsEl.innerHTML = "<p>Loading analytics...</p>";

          // Try to fetch data from the serverless function
          let apiData = null;
          try {
            const apiResponse = await fetch("/api/analytics");
            if (apiResponse.ok) {
              apiData = await apiResponse.json();
            }
          } catch (err) {
            console.log("API endpoint not available or error:", err);
          }

          // Wait a moment for scripts to load, then check analytics status
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Check if analytics script is loaded - check both window.va and window.vaq
          const vaExists = typeof window.va !== "undefined";
          const vaqExists = typeof window.vaq !== "undefined";
          const analyticsActive = vaExists || vaqExists;

          // Check if we're on a Vercel domain (for informational purposes)
          // Note: Custom domains also work with Vercel Analytics
          const isVercelDomain =
            window.location.hostname.includes("vercel.app") ||
            window.location.hostname.includes("vercel.sh");
          const isCustomDomain = !isVercelDomain;

          // Check if the analytics script file exists by trying to fetch it
          // This is the definitive check - if script exists, analytics is available
          let scriptExists = false;
          let scriptError = null;
          try {
            const response = await fetch("/_vercel/insights/script.js", {
              method: "HEAD",
            });
            scriptExists = response.ok;
            if (!response.ok) {
              scriptError = `Script returned status ${response.status}`;
            }
          } catch (err) {
            scriptError = err.message;
          }

          // If script exists but analytics isn't active, it might just need time to load
          // or the script loaded but hasn't initialized yet
          const likelyActive = scriptExists || analyticsActive;

          // Log diagnostic info to console
          console.log("Analytics Diagnostics:", {
            vaExists,
            vaqExists,
            analyticsActive,
            isVercelDomain,
            isCustomDomain,
            scriptExists,
            scriptError,
            likelyActive,
            hostname: window.location.hostname,
          });

          try {
            let html = `
              <p><strong>Vercel Analytics Status</strong></p>
              
              ${apiData && apiData.success ? `
              <div style="margin-top: 1em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <p style="margin-bottom: 0.5em; font-weight: 700;">ðŸ“Š Project Information</p>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">
                  <strong>Project:</strong> ${escapeHtml(apiData.project.name)}<br>
                  <strong>Project ID:</strong> ${escapeHtml(apiData.project.id)}<br>
                  <strong>Created:</strong> ${new Date(apiData.project.createdAt).toLocaleDateString()}
                </p>
                ${apiData.deployments && apiData.deployments.length > 0 ? `
                  <p style="margin-top: 0.75em; margin-bottom: 0.5em; font-weight: 700;">Recent Deployments:</p>
                  <ul style="font-size: 0.9em; color: #666; margin-left: 1.5em;">
                    ${apiData.deployments.slice(0, 3).map(dep => `
                      <li>
                        <a href="https://${escapeHtml(dep.url)}" target="_blank" style="color: #000; text-decoration: underline;">
                          ${escapeHtml(dep.url)}
                        </a>
                        - ${dep.state} (${new Date(dep.createdAt).toLocaleDateString()})
                      </li>
                    `).join('')}
                  </ul>
                ` : ''}
                <p style="font-size: 0.85em; color: #666; margin-top: 0.75em; font-style: italic; padding-top: 0.75em; border-top: 1px solid #ccc;">
                  ${apiData.analytics.message}
                </p>
                <p style="margin-top: 0.5em;">
                  <a href="${escapeHtml(apiData.analytics.dashboardUrl)}" target="_blank" style="color: #000; text-decoration: underline; font-weight: 700;">
                    Open Analytics Dashboard â†’
                  </a>
                </p>
              </div>
              ` : apiData && !apiData.success ? `
              <div style="margin-top: 1em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <p style="margin-bottom: 0.5em; font-weight: 700; color: #d97706;">âš  API Configuration Needed</p>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">
                  ${escapeHtml(apiData.message)}
                </p>
                ${apiData.instructions ? `
                  <p style="font-size: 0.9em; color: #666; margin-top: 0.5em; font-weight: 700;">Setup Instructions:</p>
                  <ol style="font-size: 0.9em; color: #666; margin-left: 1.5em; margin-top: 0.5em;">
                    ${apiData.instructions.map(inst => `<li>${escapeHtml(inst)}</li>`).join('')}
                  </ol>
                ` : ''}
                <p style="font-size: 0.85em; color: #666; margin-top: 0.75em; font-style: italic;">
                  ${escapeHtml(apiData.note || '')}
                </p>
              </div>
              ` : ''}
              
              <div style="margin-top: 1em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <p style="margin-bottom: 0.5em;">
                  <strong>Tracking Status:</strong> 
                  <span style="color: ${likelyActive ? "darkgreen" : "#666"};">
                    ${
                      analyticsActive
                        ? "âœ“ Active"
                        : scriptExists
                        ? "âš  Script available (may need refresh)"
                        : "Not detected"
                    }
                  </span>
                </p>
                ${
                  analyticsActive
                    ? `
                  <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                    Page views are being tracked automatically. Analytics data is collected server-side by Vercel.
                  </p>
                `
                    : scriptExists
                    ? `
                  <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                    The analytics script is available, but hasn't initialized yet. This is normal and tracking should start working shortly.
                    ${
                      isCustomDomain
                        ? " Custom domains work with Vercel Analytics."
                        : ""
                    }
                  </p>
                  <p style="font-size: 0.85em; color: #666; margin-top: 0.5em; font-style: italic;">
                    Try refreshing the page in a few moments to see if status updates to "Active".
                  </p>
                `
                    : `
                  <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                    <strong>Analytics script not available.</strong> This means:
                  </p>
                  <ul style="font-size: 0.9em; color: #666; margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Web Analytics needs to be enabled in your Vercel project settings</li>
                    <li>Go to Vercel Dashboard â†’ Your Project â†’ Settings â†’ Analytics</li>
                    <li>Enable "Web Analytics" and wait 2-3 minutes for it to activate</li>
                  </ul>
                  ${
                    isCustomDomain
                      ? `
                    <p style="font-size: 0.9em; color: #666; margin-top: 0.5em; padding: 0.5em; background-color: rgba(244, 232, 212, 0.5); border-left: 3px solid #000;">
                      <strong>Note:</strong> You're using a custom domain (${escapeHtml(
                        window.location.hostname
                      )}). 
                      Vercel Analytics works with custom domains once enabled in project settings.
                    </p>
                  `
                      : ""
                  }
                  <div style="margin-top: 1em; padding: 0.75em; background-color: rgba(0,0,0,0.05); border: 1px solid #ccc; font-size: 0.85em;">
                    <p style="margin-bottom: 0.5em; font-weight: 700;">Diagnostic Info:</p>
                    <ul style="margin-left: 1.5em; color: #666;">
                      <li>Script file exists: ${
                        scriptExists ? "âœ“ Yes" : "âœ— No"
                      }</li>
                      <li>Domain type: ${
                        isCustomDomain ? "Custom domain" : "Vercel domain"
                      }</li>
                      <li>Hostname: ${escapeHtml(window.location.hostname)}</li>
                      ${
                        scriptError
                          ? `<li style="color: darkred;">Error: ${escapeHtml(
                              scriptError
                            )}</li>`
                          : ""
                      }
                    </ul>
                    ${
                      !scriptExists
                        ? `
                      <p style="color: darkred; margin-top: 0.5em; font-weight: 700;">
                        The analytics script file is not available. Enable Web Analytics in Vercel project settings.
                      </p>
                    `
                        : ""
                    }
                  </div>
                `
                }
              </div>
              <div style="margin-top: 1.5em; padding: 1em; background-color: rgba(244, 232, 212, 0.3); border: 1px solid #000;">
                <p style="margin-bottom: 0.5em; font-weight: 700;">
                  ðŸ“Š View Site Metrics:
                </p>
                <p style="margin-top: 0.5em; margin-bottom: 0.5em;">
                  <a href="https://vercel.com/dashboard/team_KggG73fuHIucvjQ85R6a3h17/project/watchmans-cry-site/analytics" target="_blank" style="color: #000; text-decoration: underline; font-weight: 700; font-size: 1.05em;">
                    Open Analytics Dashboard â†’
                  </a>
                </p>
                <p style="font-size: 0.85em; color: #666; margin-top: 0.75em; font-style: italic;">
                  <strong>Note:</strong> Actual site metrics (page views, visitors, etc.) are displayed in the Vercel Dashboard. 
                  This page only shows tracking status. Click the link above to view detailed analytics data.
                </p>
              </div>
              <p style="font-size: 0.9em; color: #666; margin-top: 1em;">
                <strong>To enable Web Analytics:</strong>
              </p>
              <ol style="font-size: 0.9em; color: #666; margin-left: 1.5em; margin-top: 0.5em;">
                <li>Go to your Vercel Dashboard</li>
                <li>Select your project</li>
                <li>Go to Settings â†’ Analytics</li>
                <li>Enable "Web Analytics"</li>
                <li>Wait a few minutes for it to activate</li>
              </ol>
              <p style="font-size: 0.9em; color: #666; margin-top: 1em;">
                In your Vercel Dashboard, you can view:
              </p>
              <ul style="font-size: 0.9em; color: #666; margin-left: 1.5em; margin-top: 0.5em;">
                <li>Page views and unique visitors</li>
                <li>Top pages and referrers</li>
                <li>Geographic data</li>
                <li>Device and browser statistics</li>
                <li>Performance metrics</li>
              </ul>
              <p style="font-size: 0.85em; color: #666; margin-top: 1em; font-style: italic; padding-top: 1em; border-top: 1px solid #ccc;">
                <strong>Note:</strong> Analytics data appears in your project's Analytics tab after enabling Web Analytics. 
                Real-time metrics may take a few minutes to appear after enabling.
              </p>
            `;

            metricsEl.innerHTML = html;
          } catch (err) {
            console.error("Error loading analytics info:", err);
            metricsEl.innerHTML = `
              <p><strong>Vercel Analytics</strong></p>
              <p style="color: darkred;">Error loading analytics information. Check console for details.</p>
              <p style="margin-top: 1em;">
                <a href="https://vercel.com/dashboard" target="_blank" style="color: #000; text-decoration: underline; font-weight: 700;">
                  Open Vercel Dashboard â†’
                </a>
              </p>
            `;
          }
        }
      </script>
    </div>
    <!-- Page footer -->
    <div style="max-width: 800px; margin: 0 auto; padding: 0 20px">
      <img src="images/divider.png" alt="divider" class="divider" />
      <nav style="text-align: center; margin: 1em 0">
        <ul>
          <li>
            <a href="index.html">
              <span class="nav-initial">H</span
              ><span class="nav-word">ome</span>
            </a>
          </li>
          <li>
            <a href="about.html">
              <span class="nav-initial">A</span
              ><span class="nav-word">bout</span>
            </a>
          </li>
          <li>
            <a href="submit.html">
              <span class="nav-initial">S</span
              ><span class="nav-word">ubmit</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="page-footer">
        <p style="text-align: center; margin-bottom: 0.5em">
          &copy; 2026 The Watchman's Cry: Common Sense Reborn
        </p>
        RSJr. For the Republic.
      </div>
    </div>
  </body>
</html>

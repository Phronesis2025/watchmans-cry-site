<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchman Admin</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>The Watchman's Cry – Admin Only</h1>
        <img src="images/divider.png" alt="divider" class="divider" />
      </header>

      <div id="login" style="text-align: center; margin: 4em 0">
        <h3>Admin Access</h3>
        <div id="login-form" style="max-width: 400px; margin: 0 auto;">
          <input type="email" id="admin-email" placeholder="Email" style="width: 100%; padding: 0.5em; margin-bottom: 1em; border: 1px solid #000; font-family: 'EB Garamond', serif;" />
          <input type="password" id="admin-password" placeholder="Password" style="width: 100%; padding: 0.5em; margin-bottom: 1em; border: 1px solid #000; font-family: 'EB Garamond', serif;" />
          <button onclick="signIn()" style="padding: 0.75em 2em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; font-size: 1em; font-weight: 700; cursor: pointer; width: 100%;">Sign In</button>
          <p id="login-error" style="color: darkred; margin-top: 1em; display: none;"></p>
        </div>
        <div id="signup-form" style="max-width: 400px; margin: 2em auto 0; display: none;">
          <h4>Create Admin Account</h4>
          <input type="email" id="signup-email" placeholder="Email" style="width: 100%; padding: 0.5em; margin-bottom: 1em; border: 1px solid #000; font-family: 'EB Garamond', serif;" />
          <input type="password" id="signup-password" placeholder="Password (min 6 characters)" style="width: 100%; padding: 0.5em; margin-bottom: 1em; border: 1px solid #000; font-family: 'EB Garamond', serif;" />
          <button onclick="signUp()" style="padding: 0.75em 2em; background-color: #000; color: #f4e8d4; border: none; font-family: 'EB Garamond', serif; font-size: 1em; font-weight: 700; cursor: pointer; width: 100%;">Create Account</button>
          <button onclick="toggleSignup()" style="padding: 0.5em 1em; background: transparent; border: 1px solid #000; color: #000; font-family: 'EB Garamond', serif; margin-top: 1em; cursor: pointer; width: 100%;">Back to Sign In</button>
          <p id="signup-error" style="color: darkred; margin-top: 1em; display: none;"></p>
        </div>
        <button onclick="toggleSignup()" id="show-signup-btn" style="padding: 0.5em 1em; background: transparent; border: 1px solid #000; color: #000; font-family: 'EB Garamond', serif; margin-top: 1em; cursor: pointer;">Need to create an account?</button>
      </div>

      <div id="admin-content" style="display: none">
        <h2>Submissions</h2>

        <h3>Counsel Questions</h3>
        <div id="counsel-data" style="margin-bottom: 2em">
          <p>Loading...</p>
        </div>

        <h3>Site Metrics</h3>
        <div id="vercel-metrics" style="margin-bottom: 2em">
          <p>Loading Vercel Analytics...</p>
        </div>
      </div>

      <script>
        // Check if user is already signed in on page load
        window.addEventListener("DOMContentLoaded", async () => {
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session) {
            document.getElementById("login").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            loadSubmissions();
          }
        });

        function toggleSignup() {
          const loginForm = document.getElementById("login-form");
          const signupForm = document.getElementById("signup-form");
          const showSignupBtn = document.getElementById("show-signup-btn");
          
          if (signupForm.style.display === "none") {
            loginForm.style.display = "none";
            signupForm.style.display = "block";
            showSignupBtn.style.display = "none";
          } else {
            loginForm.style.display = "block";
            signupForm.style.display = "none";
            showSignupBtn.style.display = "block";
          }
        }

        async function signIn() {
          const email = document.getElementById("admin-email").value;
          const password = document.getElementById("admin-password").value;
          const errorEl = document.getElementById("login-error");

          if (!email || !password) {
            errorEl.textContent = "Please enter both email and password.";
            errorEl.style.display = "block";
            return;
          }

          errorEl.style.display = "none";

          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            errorEl.textContent = "Error: " + error.message;
            errorEl.style.display = "block";
            return;
          }

          // Success - hide login, show admin content
          document.getElementById("login").style.display = "none";
          document.getElementById("admin-content").style.display = "block";
          loadSubmissions();
        }

        async function signUp() {
          const email = document.getElementById("signup-email").value;
          const password = document.getElementById("signup-password").value;
          const errorEl = document.getElementById("signup-error");

          if (!email || !password) {
            errorEl.textContent = "Please enter both email and password.";
            errorEl.style.display = "block";
            return;
          }

          if (password.length < 6) {
            errorEl.textContent = "Password must be at least 6 characters.";
            errorEl.style.display = "block";
            return;
          }

          errorEl.style.display = "none";

          const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password,
          });

          if (error) {
            errorEl.textContent = "Error: " + error.message;
            errorEl.style.display = "block";
            return;
          }

          // Success - show message
          errorEl.style.color = "darkgreen";
          errorEl.textContent = "Account created! Please check your email to confirm, then sign in.";
          errorEl.style.display = "block";
          
          // Switch back to login form after 3 seconds
          setTimeout(() => {
            toggleSignup();
            document.getElementById("admin-email").value = email;
            errorEl.style.color = "darkred";
            errorEl.style.display = "none";
          }, 3000);
        }

        async function loadSubmissions() {
          // Load counsel questions data
          const counselEl = document.getElementById("counsel-data");
          counselEl.innerHTML = "<p>Loading counsel questions...</p>";

          try {
            console.log(
              "Attempting to load counsel questions from Supabase..."
            );
            const { data: counsel, error: counselError } = await supabaseClient
              .from("counsel_questions")
              .select("*")
              .order("created_at", { ascending: false });

            console.log("Supabase response:", {
              data: counsel,
              error: counselError,
            });

            if (counselError) {
              console.error("Supabase error:", counselError);
              counselEl.innerHTML = `
                <p style="color: darkred;"><strong>Error:</strong> ${counselError.message}</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                  <strong>Note:</strong> This is likely a Row Level Security (RLS) policy issue. 
                  To fix this, you need to:
                  <ol style="margin-left: 1.5em; margin-top: 0.5em;">
                    <li>Go to your Supabase dashboard</li>
                    <li>Navigate to Authentication → Policies for the "counsel_questions" table</li>
                    <li>Create a policy that allows SELECT operations (or temporarily disable RLS for testing)</li>
                    <li>Alternatively, use a service_role key server-side (never expose this in client code)</li>
                  </ol>
                  <p style="margin-top: 0.5em;">
                    <strong>Debug info:</strong> Check browser console (F12) for detailed error information.
                  </p>
                </p>
              `;
            } else if (!counsel || counsel.length === 0) {
              counselEl.innerHTML = "<p>No counsel questions yet.</p>";
            } else {
              console.log(`Loaded ${counsel.length} counsel questions`);
              let html = `<p><strong>Total: ${counsel.length} questions</strong></p>`;
              html += `<table style="width: 100%; border-collapse: collapse; margin-top: 1em; border: 1px solid #000;">`;
              html += `<thead>`;
              html += `<tr style="background-color: rgba(244, 232, 212, 0.5); border-bottom: 2px solid #000;">`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Date</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Name</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Profession</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">State</th>`;
              html += `<th style="padding: 0.75em; text-align: left; border: 1px solid #000; font-weight: 700;">Question</th>`;
              html += `</tr>`;
              html += `</thead>`;
              html += `<tbody>`;
              counsel.forEach((entry) => {
                const date = entry.created_at
                  ? new Date(entry.created_at).toLocaleDateString()
                  : "Date unknown";
                html += `<tr style="border-bottom: 1px solid #000;">`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${date}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${entry.name || "-"}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${entry.profession || "-"}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${entry.state || "-"}</td>`;
                html += `<td style="padding: 0.75em; border: 1px solid #000;">${entry.question || "No question text"}</td>`;
                html += `</tr>`;
              });
              html += `</tbody>`;
              html += `</table>`;
              counselEl.innerHTML = html;
            }
          } catch (err) {
            console.error("Exception loading counsel questions:", err);
            counselEl.innerHTML = `
              <p style="color: darkred;"><strong>Error loading counsel questions:</strong> ${err.message}</p>
              <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
                Check browser console (F12) for more details.
              </p>
            `;
          }

          // Load Vercel Analytics
          loadVercelMetrics();
        }

        function loadVercelMetrics() {
          const metricsEl = document.getElementById("vercel-metrics");

          // Vercel Analytics is automatically enabled for deployed projects
          // For static HTML sites, analytics are collected server-side
          metricsEl.innerHTML = `
            <p><strong>Vercel Analytics</strong></p>
            <p style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
              Vercel automatically collects analytics for all deployed projects. 
              View detailed metrics including page views, unique visitors, top pages, 
              and more in your Vercel Dashboard.
            </p>
            <p style="margin-top: 1em;">
              <a href="https://vercel.com/dashboard" target="_blank" style="color: #000; text-decoration: underline; font-weight: 700;">
                Open Vercel Dashboard →
              </a>
            </p>
            <p style="font-size: 0.85em; color: #666; margin-top: 1em; font-style: italic;">
              Note: Analytics data is available in your project's Analytics tab after deployment. 
              Real-time metrics may take a few minutes to appear.
            </p>
          `;
        }
      </script>
    </div>
    <!-- Page footer -->
    <div style="max-width: 800px; margin: 0 auto; padding: 0 20px">
      <img src="images/divider.png" alt="divider" class="divider" />
      <nav style="text-align: center; margin: 1em 0">
        <ul>
          <li>
            <a href="index.html">
              <span class="nav-initial">H</span><span class="nav-word">Home</span>
            </a>
          </li>
          <li>
            <a href="about.html">
              <span class="nav-initial">A</span><span class="nav-word">About</span>
            </a>
          </li>
          <li>
            <a href="submit.html">
              <span class="nav-initial">S</span><span class="nav-word">Submit</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="page-footer">
        <p style="text-align: center; margin-bottom: 0.5em">
          &copy; 2026 The Watchman's Cry: Common Sense Reborn
        </p>
        RSJr. For the Republic.
      </div>
    </div>
  </body>
</html>
